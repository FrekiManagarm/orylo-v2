# Story 2.3: Migrate Card Testing & Trust Score Detectors

---

## Status

**Draft**

---

## Story

**As a** system,  
**I want** card testing et trust score comme detectors indépendants,  
**so that** la logique est modulaire et réutilisable.

---

## Acceptance Criteria

1. `CardTestingDetector` créé (wraps existing `card-testing.ts` logic)
2. `TrustScoreDetector` créé (wraps existing `trust-score.ts` logic)
3. `CustomRulesDetector` intégré (déjà développé)
4. Chaque detector isolé avec tests unitaires 85%+
5. Integration dans detection pipeline
6. **Performance** : Aucune régression vs code actuel

**Integration Verification** :
- IV1: Modules existants (`card-testing.ts`, `trust-score.ts`) restent inchangés
- IV2: Detectors wrappent logique existante (delegation pattern)
- IV3: Comportement identique à 99%+
- IV4: Tests vérifient edge cases connus

---

## Tasks / Subtasks

- [ ] **Task 1: Create CardTestingDetector** (AC: 1)
  - [ ] Create `lib/fraud-detection-v2/detectors/card-testing.detector.ts`
  - [ ] Wrap existing `trackPaymentAttempt()` logic
  - [ ] Implement `IDetector` interface
  - [ ] Set priority appropriately

- [ ] **Task 2: Create TrustScoreDetector** (AC: 2)
  - [ ] Create `lib/fraud-detection-v2/detectors/trust-score.detector.ts`
  - [ ] Wrap existing `calculateTrustScore()` logic
  - [ ] Implement `IDetector` interface

- [ ] **Task 3: Create CustomRulesDetector** (AC: 3)
  - [ ] Create `lib/fraud-detection-v2/detectors/custom-rules.detector.ts`
  - [ ] Wrap existing `applyCustomRules()` logic
  - [ ] Implement `IDetector` interface

- [ ] **Task 4: Integrate into Pipeline** (AC: 5)
  - [ ] Register detectors in `FraudDetectionEngine`
  - [ ] Test full pipeline with all detectors

- [ ] **Task 5: Unit Tests** (AC: 4)
  - [ ] Test CardTestingDetector (85%+ coverage)
  - [ ] Test TrustScoreDetector (85%+ coverage)
  - [ ] Test CustomRulesDetector (85%+ coverage)

---

## Dev Notes

### Existing Code to Wrap (DO NOT MODIFY)

**Card Testing Functions** (`lib/fraud-detection/card-testing.ts`) :
- `analyzeCardTestingPattern(organizationId, invoiceId)` - Analyze card testing patterns from tracker
- `isCardTestingAttempt(attempts, currentAttempt)` - Quick check if attempt is card testing
- `getCardTestingAnalysis(organizationId, invoiceId)` - Get analysis from DB

**Trust Score Functions** (`lib/fraud-detection/trust-score.ts`) :
- `calculateTrustScore(metrics: CustomerMetrics)` - Calculate 0-100 trust score with factors
- `getTrustTier(score)` - Map score to tier (blocked, suspicious, new, trusted, vip)
- `getTierInfo(tier)` - Get tier display information

**Custom Rules Functions** (`lib/fraud-detection/custom-rules.ts`) :
- `applyCustomRules(context, organizationId)` - Apply user-defined rules with priority
- `evaluateRuleCondition(condition, context)` - Evaluate rule conditions with logical operators

### Delegation Pattern

**CRITICAL** : Detectors must **wrap** existing functions, NOT reimplement them.

```typescript
// Wrap existing logic without modifying it
export class CardTestingDetector implements IDetector {
  name = 'CardTestingDetector';
  priority = 10;

  canHandle(context: TransactionContext): boolean {
    return true; // Always applicable
  }

  async detect(context: TransactionContext): Promise<DetectorResult> {
    // Delegate to existing function from lib/fraud-detection/card-testing.ts
    const cardTestingResult = await analyzeCardTestingPattern(
      context.organizationId,
      context.invoiceId || context.paymentIntentId
    );
    
    // Transform to DetectorResult format
    return {
      detectorName: this.name,
      factors: cardTestingResult.reasons.map(r => ({
        type: r.label,
        weight: r.weight,
        severity: r.severity,
        description: r.description,
        category: 'behavior' as const,
      })),
      score: cardTestingResult.suspicionScore,
      confidence: 0.9,
      metadata: {
        metrics: cardTestingResult.metrics,
        recommendation: cardTestingResult.recommendation,
      },
    };
  }
}
```

**TrustScoreDetector Example** :
```typescript
export class TrustScoreDetector implements IDetector {
  name = 'TrustScoreDetector';
  priority = 5;

  canHandle(context: TransactionContext): boolean {
    return context.customer !== null; // Only if customer exists
  }

  async detect(context: TransactionContext): Promise<DetectorResult> {
    // Build metrics from context
    const metrics: CustomerMetrics = {
      accountAge: context.customer.accountAge || 0,
      totalPurchases: context.customer.totalPurchases || 0,
      totalSpent: context.customer.totalSpent || 0,
      avgPurchaseAmount: context.customer.avgPurchaseAmount || 0,
      disputeHistory: context.customer.disputeHistory || 0,
      refundHistory: context.customer.refundHistory || 0,
      failedPayments: context.customer.failedPayments || 0,
      uniquePaymentMethods: context.customer.uniquePaymentMethods || 1,
      hasActiveSubscription: context.customer.hasActiveSubscription || false,
      purchaseFrequency: context.customer.purchaseFrequency || 0,
      deviceConsistency: context.device?.consistency || 50,
      locationConsistency: context.location?.consistency || 50,
    };
    
    // Delegate to existing function from lib/fraud-detection/trust-score.ts
    const trustResult = calculateTrustScore(metrics);
    
    return {
      detectorName: this.name,
      factors: trustResult.factors.map(f => ({
        type: f.type,
        weight: Math.abs(f.impact),
        severity: f.category === 'negative' ? 'high' : f.category === 'positive' ? 'low' : 'medium',
        description: f.description,
        category: 'behavior' as const,
      })),
      score: 100 - trustResult.score, // Invert: trust score → risk score
      confidence: 0.85,
      metadata: {
        tier: trustResult.tier,
        shouldWhitelist: trustResult.shouldWhitelist,
        shouldBlacklist: trustResult.shouldBlacklist,
      },
    };
  }
}
```

### Testing Standards

**Test Requirements** :
- Mock existing functions (`trackPaymentAttempt`, `calculateTrustScore`, etc.)
- Verify delegation works correctly
- Test edge cases from existing code
- 85%+ coverage per detector

---

## Testing

**Acceptance** :
- All 6 acceptance criteria met
- 85%+ test coverage per detector
- No performance regression
- Behavior identical to V1 (99%+)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Story created from PRD | Sarah (PO) |

---
