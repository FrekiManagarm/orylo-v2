# Story 4.1: AI Prompts Improvement for Better Explanations

---

## Status

Draft

---

## Story

**As a** fraud detection system,
**I want** improved AI prompts that generate more detailed and actionable fraud explanations,
**so that** merchants better understand why transactions were flagged and what actions to take.

---

## Acceptance Criteria

1. Enhance `FRAUD_EXPLANATION_PROMPT` in `lib/mastra/prompts.ts` with more detailed sections
2. Add "Comparaison avec Comportement Normal" section to provide context
3. Improve "Analyse Card Testing" section with concrete examples and patterns
4. Add more details on risk factor weights and their impact on final decision
5. Improve `buildFraudExplanationPrompt()` to include additional metrics (velocity details, customer history)
6. Explanations remain structured in Markdown format with clear sections
7. Test prompts with different fraud scenarios (card testing, velocity, trust score)
8. Latency remains < 2 seconds (NFR1) and token usage is optimized

---

## Tasks / Subtasks

- [ ] Analyze current prompts and identify improvement areas (AC: 1)
  - [ ] Read current `FRAUD_EXPLANATION_PROMPT` in `lib/mastra/prompts.ts`
  - [ ] Identify sections that need more detail
  - [ ] Review example outputs from current prompts
  - [ ] List specific improvements needed

- [ ] Enhance prompt structure with new sections (AC: 1, 2, 3, 4)
  - [ ] Add "Comparaison avec Comportement Normal" section:
    - Compare transaction with typical legitimate transactions
    - Highlight specific anomalies (e.g., "10x faster than normal checkout")
    - Provide benchmarks (e.g., "Normal: 2-5 min, This: 10 sec")
  - [ ] Improve "Analyse Card Testing" section:
    - Add concrete examples: "3 cartes diffÃ©rentes en 30 secondes suggÃ¨re un script automatisÃ©"
    - Explain patterns: "SÃ©quence fail-fail-fail-success typique d'attaque card testing"
    - Provide detection logic: "Seuil dÃ©passÃ©: 5+ cartes uniques (limite: 3)"
  - [ ] Enhance "Facteurs de Risque IdentifiÃ©s" section:
    - Add weight for each factor: "ðŸ”´ Nouvelle carte (+30 points)"
    - Explain cumulative impact: "Score total: 85/100 (seuil blocage: 80)"
    - Prioritize factors by severity
  - [ ] Add "Recommandation d'Action" section:
    - Suggest specific actions: "Bloquer IP 192.168.1.1"
    - Explain rationale: "Customer historique propre mais carte suspecte â†’ vÃ©rifier avec customer"

- [ ] Improve context passed to AI (AC: 5)
  - [ ] Enhance `buildFraudExplanationPrompt()` in `lib/mastra/prompts.ts`
  - [ ] Add more velocity metrics:
    - Total transactions in last 24h
    - Average time between transactions
    - Comparison with organization average
  - [ ] Add more customer history:
    - Total successful purchases
    - Account age
    - Previous fraud incidents
    - Trust score evolution
  - [ ] Add card details:
    - Card brand, country, BIN range
    - First time seen or repeat card
    - Card fingerprint history

- [ ] Maintain Markdown structure (AC: 6)
  - [ ] Ensure output format remains:
    ```markdown
    ## RÃ©sumÃ©
    ## Analyse Card Testing
    ## Comparaison avec Comportement Normal (NEW)
    ## Facteurs de Risque IdentifiÃ©s
    ## Recommandation d'Action (NEW)
    ```
  - [ ] Use proper Markdown formatting (headings, lists, bold, code blocks)
  - [ ] Ensure rendering compatibility with dashboard components

- [ ] Test prompts with different scenarios (AC: 7)
  - [ ] Generate explanations for:
    - Card testing attack (multiple unique cards)
    - Velocity anomaly (too many transactions)
    - New customer with high-value purchase
    - Suspicious IP (VPN, proxy)
    - Trust score blacklisted customer
  - [ ] Verify each explanation is detailed and actionable
  - [ ] Verify Markdown rendering is correct
  - [ ] Compare with previous prompts (qualitative improvement)

- [ ] Optimize for latency and token usage (AC: 8)
  - [ ] Measure prompt length (tokens)
  - [ ] Test latency with new prompts (should be < 2s)
  - [ ] Monitor `aiTokensUsed` and `aiLatencyMs` in `fraudDetections` table
  - [ ] Adjust prompt if latency exceeds threshold
  - [ ] Consider fallback to shorter prompt if AI service is slow

---

## Dev Notes

### Relevant Source Tree

**Files to Modify:**
- `lib/mastra/prompts.ts` - Prompt templates and `buildFraudExplanationPrompt()`

**Dependencies:**
- `lib/mastra/index.ts` - `generateFraudExplanation()` uses these prompts
- `lib/fraud-detection/types.ts` - Type definitions for context data
- `lib/actions/stripe-webhook-handlers.ts` - Calls `generateFraudExplanation()` ligne ~204-235

**Current Prompt Structure:**
```typescript
// lib/mastra/prompts.ts
export const FRAUD_EXPLANATION_PROMPT = `
Tu es un expert en dÃ©tection de fraude e-commerce, spÃ©cialisÃ© dans l'analyse de transactions Stripe.

# Contexte
{context}

# Ta Mission
GÃ©nÃ¨re une explication claire et dÃ©taillÃ©e en franÃ§ais de la dÃ©cision de blocage.

# Format de RÃ©ponse (Markdown)
## RÃ©sumÃ©
[RÃ©sumÃ© en 2-3 phrases]

## Analyse Card Testing
[Si dÃ©tectÃ©, expliquer les patterns identifiÃ©s]

## Facteurs de Risque IdentifiÃ©s
[Liste des facteurs avec sÃ©vÃ©ritÃ©]

## Recommandation
[Action suggÃ©rÃ©e pour le marchand]
`;
```

**Enhanced Prompt Example:**
```typescript
export const FRAUD_EXPLANATION_PROMPT = `
Tu es un expert en dÃ©tection de fraude e-commerce, spÃ©cialisÃ© dans l'analyse de transactions Stripe.

# Contexte Transaction
{context}

# MÃ©triques de RÃ©fÃ©rence
{normalBehaviorMetrics}

# Ta Mission
GÃ©nÃ¨re une explication DÃ‰TAILLÃ‰E et ACTIONNABLE en franÃ§ais de la dÃ©cision de fraude.
IMPORTANT: Inclure des chiffres prÃ©cis, des comparaisons, et des exemples concrets.

# Format de RÃ©ponse (Markdown)

## RÃ©sumÃ©
[RÃ©sumÃ© en 2-3 phrases avec score de risque et dÃ©cision]

## Analyse Card Testing
[Si dÃ©tectÃ©, expliquer:]
- Pattern identifiÃ© (fail-fail-success, multiple cards, etc.)
- MÃ©triques prÃ©cises (X cartes en Y secondes)
- Comparaison avec seuils normaux
- Exemple concret de ce qui a dÃ©clenchÃ© l'alerte

## Comparaison avec Comportement Normal
[Comparer avec transactions lÃ©gitimes:]
- Temps de checkout: Transaction actuelle vs Normal
- FrÃ©quence de tentatives: Transaction actuelle vs Normal
- CaractÃ©ristiques carte: Nouvelle vs RÃ©currente
- Localisation: CohÃ©rente vs Suspecte

## Facteurs de Risque IdentifiÃ©s
[Pour chaque facteur:]
- ðŸ”´/ðŸŸ¡/ðŸŸ¢ Nom du facteur (+XX points)
- Explication dÃ©taillÃ©e avec valeur mesurÃ©e
- Impact sur score final

[Calcul final:]
Score total: XX/100 (Seuil BLOCK: 80, REVIEW: 60)

## Recommandation d'Action
[Actions spÃ©cifiques:]
1. Action immÃ©diate (bloquer IP, contacter customer, etc.)
2. Action prÃ©ventive (ajuster rÃ¨gles, whitelist, etc.)
3. Monitoring (surveiller customer, IP, carte)

**Rationale:** [Expliquer pourquoi ces actions]
`;
```

**Enhanced Context Builder:**
```typescript
export function buildFraudExplanationPrompt(
  context: TransactionContext,
  result: FraudDetectionResult,
  velocityData: VelocityData, // NEW
  customerHistory: CustomerHistory // NEW
): string {
  const normalBehaviorMetrics = {
    avgCheckoutTime: "2-5 minutes",
    avgTransactionsPerDay: "< 10",
    avgCardReuse: "70% same card",
    avgSuccessRate: "> 95%",
  };
  
  return FRAUD_EXPLANATION_PROMPT
    .replace("{context}", JSON.stringify(context, null, 2))
    .replace("{normalBehaviorMetrics}", JSON.stringify(normalBehaviorMetrics, null, 2));
}
```

**Existing Patterns to Follow:**
- Markdown structure with `##` headings
- French language for all explanations
- Structured data passed to AI via JSON
- Response format strictly enforced in prompt

**Critical Constraints:**
- Latency MUST remain < 2 seconds (NFR1)
- Token usage should not explode (monitor costs)
- Markdown format must be compatible with dashboard rendering
- Explanations must be understandable for non-technical merchants
- Include actionable recommendations (not just analysis)

**Performance Monitoring:**
```typescript
// Already tracked in fraudDetections table:
- aiTokensUsed: number
- aiLatencyMs: number
// Monitor these after changes
```

### Testing

**Test Framework:** Manual testing + automated quality checks

**Testing Standards:**
- Generate explanations for 10+ different fraud scenarios
- Compare quality with previous prompts (subjective evaluation)
- Measure latency and token usage
- Verify Markdown rendering in dashboard

**Test Coverage Requirements:**
- All fraud types tested (card testing, velocity, trust score, IP)
- All new sections present in output
- Latency < 2s for all scenarios
- Token usage reasonable (< 1000 tokens per explanation)

**Test Scenarios:**
1. Card testing attack â†’ detailed pattern analysis with metrics
2. Velocity anomaly â†’ comparison with normal behavior
3. New customer, high-value â†’ risk factors with weights
4. VIP customer blocked by mistake â†’ explanation of false positive
5. Trust score blacklist â†’ customer history context
6. Multiple risk factors â†’ combined analysis with prioritization

**Quality Metrics:**
- Explanations include specific numbers (not vague)
- Recommendations are actionable (specific actions)
- Comparisons with normal behavior are clear
- Markdown renders correctly in dashboard
- Merchants can understand without technical knowledge

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 4 | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
