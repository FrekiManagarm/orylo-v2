# Story 1.1: Auto-Refund Logic Implementation

---

## Status

Ready for Review

---

## Story

**As a** fraud detection system,
**I want** an automated refund logic module that can create Stripe refunds for fraudulent payments,
**so that** fraudulent payments that succeeded before detection are automatically refunded, reducing merchant losses.

---

## Acceptance Criteria

1. Create `lib/actions/auto-refund.ts` module with `autoRefundFraudulentPayment()` function
2. Function must verify fraud confirmation before refunding (check `actualOutcome === "fraud_confirmed"` OR `riskScore >= 80` AND `decision === "BLOCK"`)
3. Use Stripe API `refunds.create()` with `reason: "fraudulent"`
4. Handle Stripe API errors gracefully with detailed logging
5. Return refund ID and status for database update
6. Include retry logic for temporary Stripe API failures
7. Unit tests cover all refund scenarios (confirmed fraud, high-risk fraud, legitimate payment)
8. Logging captures all refund attempts for audit trail

---

## Tasks / Subtasks

- [x] Create `lib/actions/auto-refund.ts` module (AC: 1)
  - [x] Add `"use server"` directive and TypeScript strict mode
  - [x] Import necessary types from `lib/fraud-detection/types.ts` and `lib/db/schemas`
  - [x] Import Stripe client utilities from `lib/stripe/client.ts`

- [x] Implement `autoRefundFraudulentPayment()` function (AC: 1, 2, 3, 5)
  - [x] Function signature: `async function autoRefundFraudulentPayment(paymentIntentId: string, organizationId: string, fraudDetectionId: string): Promise<{ success: boolean; refundId?: string; error?: string }>`
  - [x] Fetch fraud detection record from DB to verify fraud status
  - [x] Check idempotency: if refund already exists, return early with existing refund ID
  - [x] Verify refund eligibility: check `actualOutcome === "fraud_confirmed"` OR (`riskScore >= 80` AND `decision === "BLOCK"`)
  - [x] Get connected Stripe client using `getConnectedStripeClient(organizationId)`
  - [x] Call `stripe.refunds.create({ payment_intent: paymentIntentId, reason: "fraudulent" })`
  - [x] Return success response with refund ID

- [x] Implement error handling and retry logic (AC: 4, 6, 8)
  - [x] Wrap Stripe API call in try-catch block
  - [x] Log all refund attempts with structured logging (tslog)
  - [x] Implement exponential backoff retry for temporary Stripe errors (max 3 retries)
  - [x] Handle specific Stripe errors: already refunded, payment not found, insufficient funds
  - [x] Return detailed error messages for failed refunds

- [x] Write unit tests (AC: 7)
  - [x] Test confirmed fraud refund (actualOutcome === "fraud_confirmed")
  - [x] Test high-risk fraud refund (riskScore >= 80, decision === "BLOCK")
  - [x] Test rejection of legitimate payment (riskScore < 80)
  - [x] Test Stripe API error handling (payment not found, already refunded)
  - [x] Test retry logic with temporary failures
  - [x] Mock Stripe client and database queries

---

## Dev Notes

### Relevant Source Tree

**Integration Point:**
- `lib/actions/stripe-webhook-handlers.ts` ligne ~399 - `handlePaymentIntentSucceeded()` will call this function

**Dependencies:**
- `lib/stripe/client.ts` - `getConnectedStripeClient()` for Stripe API access
- `lib/db/schemas/fraudDetections.ts` - Table with `refundId`, `actualOutcome`, `riskScore`, `decision` fields
- `lib/fraud-detection/types.ts` - Type definitions for `FraudDecision`

**Type Definitions:**
```typescript
// FraudDetection type structure (from lib/db/schemas/fraudDetections.ts)
type FraudDetection = {
  id: string;
  organizationId: string;
  paymentIntentId: string;
  riskScore: number;
  decision: "ALLOW" | "BLOCK" | "REVIEW";
  actualOutcome: "fraud_confirmed" | "legitimate" | "pending" | null;
  refundId: string | null;
  actionTaken: string | null;
  // ... other fields
};
```

**Existing Patterns to Follow:**
- Server Actions pattern: `"use server"` directive at top of file
- Multi-tenant isolation: Always pass `organizationId` and use `getConnectedStripeClient(organizationId)`
- Error handling: Use try-catch with detailed logging via `logger` from `lib/logger.ts`
- Database access: Use Drizzle ORM with `db` from `lib/db/index.ts`
- Return type pattern: `{ success: boolean; data?: T; error?: string }`

**Critical Constraints:**
- NEVER refund legitimate payments: strict verification with `actualOutcome === "fraud_confirmed"` OR high-risk score
- Rate limiting: respect Stripe API limits (no more than 100 requests/second)
- Idempotency: check if refund already exists before creating new one
- Logging: MUST log every refund attempt for audit and compliance

**Fetch Fraud Detection and Check Idempotency:**
```typescript
// Fetch fraud detection record from database
const fraudDetection = await db.query.fraudDetections.findFirst({
  where: eq(fraudDetections.id, fraudDetectionId),
});

if (!fraudDetection) {
  logger.error("Fraud detection not found", { fraudDetectionId });
  return { success: false, error: "Fraud detection not found" };
}

// Idempotency check: refund already created
if (fraudDetection.refundId) {
  logger.info("Refund already exists", { fraudDetectionId, refundId: fraudDetection.refundId });
  return { success: true, refundId: fraudDetection.refundId };
}
```

**Fraud Verification Logic:**
```typescript
// Refund ONLY if:
// 1. Fraud confirmed by chargeback/dispute (actualOutcome === "fraud_confirmed")
// OR
// 2. Initial detection blocked with high confidence (riskScore >= 80 AND decision === "BLOCK")
const shouldRefund = 
  fraudDetection.actualOutcome === "fraud_confirmed" ||
  (fraudDetection.riskScore >= 80 && fraudDetection.decision === "BLOCK");

if (!shouldRefund) {
  logger.info("Refund not eligible", { fraudDetectionId, riskScore: fraudDetection.riskScore });
  return { success: false, error: "Not eligible for refund" };
}
```

**Stripe Refund API:**
```typescript
const refund = await stripe.refunds.create({
  payment_intent: paymentIntentId,
  reason: "fraudulent", // Important: marks refund as fraud-related
  metadata: {
    fraud_detection_id: fraudDetectionId,
    auto_refunded: "true",
  },
});
```

### Testing

**Test Framework:** Use Vitest (recommended in architecture)

**Test File Location:** `lib/actions/__tests__/auto-refund.test.ts`

**Testing Standards:**
- Unit tests must cover all code paths (happy path, error cases, edge cases)
- Mock external dependencies (Stripe client, database queries)
- Test retry logic with temporary failures
- Test idempotency (calling function twice should not create duplicate refunds)
- Use snapshot testing for error messages

**Test Coverage Requirements:**
- Minimum 80% code coverage
- All acceptance criteria must have corresponding tests

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 1 | Sarah (Product Owner) |
| 2026-01-08 | 1.1 | Added fraud detection fetch query, idempotency check, and FraudDetection type definition | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

No critical issues encountered during development. All tests passed successfully on first run after mock syntax correction.

### Completion Notes List

- ✅ Created `lib/actions/auto-refund.ts` with full refund logic, retry mechanism, and comprehensive error handling
- ✅ Implemented idempotency check to prevent duplicate refunds
- ✅ Added fraud eligibility verification (actualOutcome === "fraud_confirmed" OR riskScore >= 80 + decision === "BLOCK")
- ✅ Implemented exponential backoff retry logic (max 3 attempts) with 1s → 2s → 4s delays
- ✅ Handled specific Stripe errors: charge_already_refunded, resource_missing, payment_intent_invalid_parameter
- ✅ Added comprehensive logging with tslog for audit trail
- ✅ Created complete test suite with 13 unit tests covering all scenarios (100% pass rate)
- ✅ Tests cover: success cases, idempotency, eligibility checks, error handling, retry logic
- ✅ All acceptance criteria validated through tests

### File List

**Created:**
- `lib/actions/auto-refund.ts` - Main auto-refund module (258 lines)
- `lib/actions/__tests__/auto-refund.test.ts` - Complete test suite (533 lines, 13 tests)

**Modified:**
- None (no integration yet - Story 1.2 will integrate into webhook handlers)

---

## QA Results

_To be filled by QA agent_
