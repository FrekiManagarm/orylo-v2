# Story 2.2: Implement Pluggable Detection Engine

---

## Status

**Draft**

---

## Story

**As a** developer,  
**I want** un detection engine modulaire avec detectors pluggables,  
**so that** je peux ajouter/modifier des règles sans toucher au core engine.

---

## Acceptance Criteria

1. `FraudDetectionEngine` créé avec detection pipeline (Chain of Responsibility)
2. Base `IDetector` interface implémentée
3. Detectors initiaux créés :
   - `GeographicDetector` (IP country vs card country)
   - `VelocityDetector` (attempts, rapid payment)
   - `AmountDetector` (unusual amounts, thresholds)
   - `BlacklistDetector` (instant block)
4. Pipeline exécute detectors par priorité
5. Scoring strategy pluggable (additif V1, multiplicatif/ML optionnel V2)
6. **Config-driven rules** : Seuils externalisés dans `fraud-detection.config.ts`
7. Tests unitaires : 90%+ coverage engine + each detector

**Integration Verification** :
- IV1: Ancien `engine.ts` reste fonctionnel (pas touché)
- IV2: Nouveau engine retourne même format `FraudDetectionResult`
- IV3: **Shadow mode** : Compare décisions ancien vs nouveau (> 99% agreement)
- IV4: Performance égale ou meilleure

**Rollback Considerations** :
- Feature flag `USE_NEW_ENGINE` pour routing
- Shadow mode obligatoire avant activation (1-2 semaines)
- Automatic rollback si agreement < 95%

---

## Tasks / Subtasks

- [ ] **Task 1: Create FraudDetectionEngine** (AC: 1, 2)
  - [ ] Create `lib/fraud-detection-v2/core/engine.ts`
  - [ ] Implement `IFraudDetectionEngine` interface
  - [ ] Implement detection pipeline (Chain of Responsibility pattern)
  - [ ] Add detector registration logic
  - [ ] Add scoring strategy injection

- [ ] **Task 2: Create Initial Detectors** (AC: 3)
  - [ ] Create `lib/fraud-detection-v2/detectors/geographic.detector.ts`
  - [ ] Create `lib/fraud-detection-v2/detectors/velocity.detector.ts`
  - [ ] Create `lib/fraud-detection-v2/detectors/amount.detector.ts`
  - [ ] Create `lib/fraud-detection-v2/detectors/blacklist.detector.ts`
  - [ ] Each implements `IDetector` interface

- [ ] **Task 3: Implement Scoring Strategies** (AC: 5)
  - [ ] Create `lib/fraud-detection-v2/core/scoring-strategies/additive-strategy.ts`
  - [ ] Create `lib/fraud-detection-v2/core/scoring-strategies/weighted-strategy.ts`
  - [ ] Implement `IScoringStrategy` interface

- [ ] **Task 4: Externalize Configuration** (AC: 6)
  - [ ] Create `lib/fraud-detection-v2/config/fraud-detection.config.ts`
  - [ ] Move thresholds from code to config
  - [ ] Add config validation

- [ ] **Task 5: Implement Shadow Mode** (AC: IV3)
  - [ ] Add feature flag `USE_NEW_ENGINE`
  - [ ] Execute both engines in parallel
  - [ ] Compare results and log divergences
  - [ ] Calculate agreement percentage

- [ ] **Task 6: Unit Tests** (AC: 7)
  - [ ] Test engine.ts (90%+ coverage)
  - [ ] Test each detector (90%+ coverage each)
  - [ ] Test scoring strategies
  - [ ] Test shadow mode comparison logic

---

## Dev Notes

### Relevant Architecture Information

**From `docs/architecture.md` - Component Architecture** :

**FraudDetectionEngine** :
```typescript
export interface IFraudDetectionEngine {
  detect(context: TransactionContext): Promise<FraudDetectionResult>;
  registerDetector(detector: IDetector): void;
  setScoringStrategy(strategy: IScoringStrategy): void;
}

export class FraudDetectionEngine implements IFraudDetectionEngine {
  private detectors: IDetector[] = [];
  private scoringStrategy: IScoringStrategy;

  constructor(scoringStrategy: IScoringStrategy) {
    this.scoringStrategy = scoringStrategy;
  }

  registerDetector(detector: IDetector): void {
    this.detectors.push(detector);
    // Sort by priority (1 = highest)
    this.detectors.sort((a, b) => a.priority - b.priority);
  }

  async detect(context: TransactionContext): Promise<FraudDetectionResult> {
    const results: DetectorResult[] = [];
    
    for (const detector of this.detectors) {
      if (detector.canHandle(context)) {
        const result = await detector.detect(context);
        results.push(result);
      }
    }
    
    return this.scoringStrategy.aggregate(results, context);
  }
}
```

**IDetector Interface** :
```typescript
export interface IDetector {
  name: string;
  priority: number;              // 1 = highest, 100 = lowest
  canHandle(context: TransactionContext): boolean;
  detect(context: TransactionContext): Promise<DetectorResult>;
}

export interface DetectorResult {
  detectorName: string;
  factors: FraudFactor[];
  score: number;                  // 0-100
  confidence: number;             // 0-1
  metadata?: Record<string, unknown>;
}
```

**IScoringStrategy Interface** :
```typescript
export interface IScoringStrategy {
  aggregate(results: DetectorResult[], context: TransactionContext): FraudDetectionResult;
}
```

### Config-Driven Rules Example

```typescript
// lib/fraud-detection-v2/config/fraud-detection.config.ts
export const fraudDetectionConfig = {
  thresholds: {
    geographic: {
      ipCountryMismatch: 30,      // Risk score if IP != card country
      highRiskCountries: ['XX', 'YY'],
    },
    velocity: {
      attemptsPerHour: 10,
      rapidPaymentThreshold: 5,    // Payments within 5 minutes
    },
    amount: {
      unusuallyLow: 1.00,          // < $1 suspicious
      unusuallyHigh: 10000.00,     // > $10k suspicious
    },
  },
  scoring: {
    blockThreshold: 80,
    reviewThreshold: 50,
  },
};
```

### Testing Standards

**Test File Location** : `lib/fraud-detection-v2/core/__tests__/engine.test.ts`

**Test Requirements** :
- Mock all detectors
- Test detector registration and priority sorting
- Test pipeline execution
- Test scoring strategy integration
- Test shadow mode comparison
- 90%+ coverage required

---

## Testing

### Test Requirements for This Story

**Unit Tests** :
- Test FraudDetectionEngine (90%+ coverage)
- Test each detector independently (90%+ coverage each)
- Test scoring strategies
- Test config loading and validation

**Integration Tests** :
- Test full detection pipeline with real detectors
- Compare old vs new engine results (shadow mode)
- Verify >= 99% agreement

**Acceptance** :
- All 7 acceptance criteria met
- 90%+ test coverage
- Shadow mode shows >= 99% agreement
- Performance equal or better than V1

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA Agent after story completion._

---
