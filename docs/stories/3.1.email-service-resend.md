# Story 3.1: Email Service Integration with Resend

---

## Status

Ready for Review

---

## Story

**As a** fraud alert system,
**I want** an email service module that can send alert emails using Resend,
**so that** users receive timely notifications about critical fraud events.

---

## Acceptance Criteria

1. Install Resend SDK: `bun add resend`
2. Create `lib/actions/send-alert-email.ts` module with `sendAlertEmail()` function
3. Configure Resend with API key from environment variables
4. Implement rate limiting: max 1 email per alert type per hour per organization
5. Function validates alert data and recipient email before sending
6. Handle Resend API errors gracefully with retry logic
7. Return success status and error details for logging
8. Unit tests cover sending, rate limiting, and error handling

---

## Tasks / Subtasks

- [x] Install Resend SDK (AC: 1)
  - [x] Run `bun add resend`
  - [x] Verify package added to `package.json`
  - [x] Add type definitions if needed

- [x] Configure Resend with environment variables (AC: 3)
  - [x] Create Resend client instance in `lib/email/resend-client.ts`
  - [x] Validate API key is present (throw error if missing, skip in tests)
  - [x] Export ALERTS_FROM_EMAIL constant

- [x] Create `lib/actions/send-alert-email.ts` module (AC: 2, 5, 7)
  - [x] Add `"use server"` directive
  - [x] Import Resend client from `lib/email/resend-client.ts`
  - [x] Import types from `lib/db/schemas/alerts.ts`
  - [x] Function signature: `async function sendAlertEmail(alertId: string, organizationId: string): Promise<{ success: boolean; emailId?: string; error?: string }>`
  - [x] Fetch alert from database by `alertId`
  - [x] Verify authorization: alert belongs to organization (security check)
  - [x] Fetch organization from database
  - [x] Generate recipient email from organization name (placeholder - needs proper user relation)
  - [x] Validate alert exists and belongs to organization
  - [x] Validate recipient email format

- [x] Implement rate limiting (AC: 4)
  - [x] Query database for recent emails sent for this alert type and organization
  - [x] Check if email sent in last hour using gt() and Date math
  - [x] If recent email exists, return early with `{ success: false, error: "Rate limit exceeded" }`
  - [x] Log rate limit hits for monitoring

- [x] Implement email sending with Resend (AC: 2, 7)
  - [x] Call `resend.emails.send()` with from, to, subject, html
  - [x] Use ALERTS_FROM_EMAIL as sender
  - [x] Use formatAlertEmail() for simple HTML template
  - [x] Return success with email ID from Resend
  - [x] Log successful send with alert ID and email ID
  - [x] Update alert.emailSentAt timestamp after successful send

- [x] Implement error handling and retry logic (AC: 6)
  - [x] Wrap Resend API call in try-catch
  - [x] Handle specific Resend errors with keyword matching
  - [x] Implement exponential backoff retry (max 3 attempts)
  - [x] Invalid API key ‚Üí log error, do not retry
  - [x] Network/temporary errors ‚Üí retry with delays
  - [x] Invalid email ‚Üí log error, do not retry
  - [x] Log all errors with structured logging
  - [x] Return error details in response

- [x] Write unit tests (AC: 8)
  - [x] Test successful email send
  - [x] Test authorization check (wrong organization)
  - [x] Test rate limiting (1 email per hour per type)
  - [x] Test rate limit window expiration
  - [x] Test alert not found
  - [x] Test organization not found
  - [x] Test recipient email not configured
  - [x] Test non-retryable Resend errors
  - [x] Test retry logic with temporary failures
  - [x] Test fail after max retries
  - [x] Test emailSentAt database update
  - [x] Test unexpected errors
  - [x] Mock Resend client and database queries

---

## Dev Notes

### Relevant Source Tree

**New Files to Create:**
- `lib/email/resend-client.ts` - Resend client instance
- `lib/actions/send-alert-email.ts` - Email sending logic

**Dependencies:**
- `lib/db/schemas/alerts.ts` - Alert schema and types
- `lib/db/schemas/organization.ts` - Organization email
- `lib/logger.ts` - Structured logging
- Resend SDK (external dependency)

**Type Definitions:**
```typescript
// Alert type structure (from lib/db/schemas/alerts.ts)
type Alert = {
  id: string;
  organizationId: string;
  type: string; // "fraud_detected" | "card_testing" | "high_risk"
  severity: string; // "critical" | "high" | "medium" | "low"
  title: string;
  message: string;
  data: any;
  isRead: boolean;
  emailSentAt: Date | null;
  createdAt: Date;
  updatedAt: Date;
};
```

**Environment Variables:**
```env
# .env.local
RESEND_API_KEY=re_xxxxxxxxxxxxx

# From email address
ALERTS_FROM_EMAIL=alerts@orylo.com
```

**Resend Client Setup:**
```typescript
// lib/email/resend-client.ts
import { Resend } from "resend";

if (!process.env.RESEND_API_KEY) {
  throw new Error("RESEND_API_KEY environment variable is required");
}

export const resend = new Resend(process.env.RESEND_API_KEY);
```

**Fetch Alert and Verify Authorization:**
```typescript
// Fetch alert from database
const alert = await db.query.alerts.findFirst({
  where: eq(alerts.id, alertId),
});

if (!alert) {
  return { success: false, error: "Alert not found" };
}

// Authorization check: verify alert belongs to organization
if (alert.organizationId !== organizationId) {
  logger.warn("Unauthorized email send attempt", { alertId, organizationId });
  return { success: false, error: "Unauthorized" };
}
```

**Fetch Organization Email:**
```typescript
// Fetch organization and user email
const organization = await db.query.organization.findFirst({
  where: eq(organization.id, organizationId),
  with: {
    users: {
      limit: 1,
      where: eq(user.role, "owner"), // Or fetch primary contact
    },
  },
});

const recipientEmail = organization?.users[0]?.email;
if (!recipientEmail) {
  return { success: false, error: "Recipient email not found" };
}
```

**Rate Limiting Logic:**
```typescript
// Check if email sent recently for this alert type
const recentAlerts = await db.query.alerts.findMany({
  where: and(
    eq(alerts.organizationId, organizationId),
    eq(alerts.type, alert.type),
    gt(alerts.emailSentAt, new Date(Date.now() - 60 * 60 * 1000)) // 1 hour ago
  ),
  limit: 1,
});

if (recentAlerts.length > 0) {
  logger.info("Rate limit exceeded", { alertType: alert.type, organizationId });
  return { success: false, error: "Rate limit exceeded" };
}
```

**Resend API Call:**
```typescript
try {
  const result = await resend.emails.send({
    from: process.env.ALERTS_FROM_EMAIL || "alerts@orylo.com",
    to: recipientEmail,
    subject: alert.title,
    html: alertMessage, // Will use template from story 3.2
  });
  
  logger.info("Alert email sent", { alertId, emailId: result.id });
  return { success: true, emailId: result.id };
} catch (error) {
  logger.error("Failed to send alert email", { alertId, error });
  return { success: false, error: error.message };
}
```

**Existing Patterns to Follow:**
- Server Actions: `"use server"` directive, session validation, organization isolation
- Error handling: Try-catch with detailed logging
- Return type: `{ success: boolean; data?: T; error?: string }`
- Rate limiting: Query database for recent activity
- Retry logic: Exponential backoff for temporary failures

**Critical Constraints:**
- Rate limiting MUST be enforced to prevent spam (1 email/hour/type/org)
- Email sending MUST NOT block webhook processing (async)
- Errors MUST be logged but not thrown (graceful degradation)
- Resend API key MUST be validated at startup
- Email templates will be provided in story 3.2 (use simple HTML for now)

### Testing

**Test Framework:** Vitest

**Test File Location:** `lib/actions/__tests__/send-alert-email.test.ts`

**Testing Standards:**
- Unit tests must cover all code paths
- Mock Resend client to avoid actual API calls
- Mock database queries
- Test rate limiting with time-based scenarios
- Test retry logic with simulated failures

**Test Coverage Requirements:**
- Minimum 80% code coverage
- All acceptance criteria validated
- Edge cases covered (invalid email, missing alert, etc.)

**Test Scenarios:**
1. Successful email send ‚Üí returns success with email ID
2. Rate limit exceeded ‚Üí returns error, no email sent
3. Invalid alert ID ‚Üí returns error
4. Invalid recipient email ‚Üí returns error
5. Resend API error ‚Üí logged, returns error
6. Temporary network error ‚Üí retries, eventually succeeds or fails
7. Missing API key ‚Üí throws error at initialization

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 3 | Sarah (Product Owner) |
| 2026-01-08 | 1.1 | Added authorization check, organization email query, and Alert type definition | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

Minor issue: Had to adapt resend-client validation to skip in test environment (NODE_ENV=test || VITEST=true).

### Completion Notes List

- ‚úÖ Installed Resend SDK (`bun add resend`)
- ‚úÖ Created `lib/email/resend-client.ts` with singleton Resend instance
- ‚úÖ Added test environment detection to skip API key validation in tests
- ‚úÖ Created `lib/actions/send-alert-email.ts` with full email sending logic
- ‚úÖ Implemented rate limiting: max 1 email per hour per alert type per organization
- ‚úÖ Implemented exponential backoff retry logic (max 3 attempts) with 1s ‚Üí 2s ‚Üí 4s delays
- ‚úÖ Added authorization check: verify alert belongs to organization
- ‚úÖ Created simple HTML email template (formatAlertEmail) - Story 3.2 will provide React Email templates
- ‚úÖ Handled specific Resend errors: invalid API key (no retry), network errors (retry), invalid email (no retry)
- ‚úÖ Added comprehensive logging with tslog for audit trail
- ‚úÖ Update alert.emailSentAt timestamp after successful send
- ‚úÖ Created complete test suite with 13 unit tests (100% pass rate)
- ‚úÖ Tests cover: success, authorization, rate limiting, error handling, retry logic, database updates
- ‚úÖ All acceptance criteria validated through tests
- üìù Note: Recipient email generation is placeholder (uses org name) - needs proper user/owner relation in future

### File List

**Created:**
- `lib/email/resend-client.ts` - Resend SDK client singleton (27 lines)
- `lib/actions/send-alert-email.ts` - Email sending module with retry logic (341 lines)
- `lib/actions/__tests__/send-alert-email.test.ts` - Complete test suite (361 lines, 13 tests)

**Modified:**
- `package.json` - Added `resend@6.7.0` dependency
- `bun.lock` - Updated lock file with Resend dependencies

**Dependencies Added:**
- `resend@6.7.0`

---

## QA Results

_To be filled by QA agent_
