# Story 4.2: Gradual Rollout & V1 Cleanup

---

## Status

**Draft**

---

## Story

**As a** maintainer,  
**I want** supprimer l'ancien code et finaliser la documentation,  
**so that** le codebase est clean et les futurs développeurs ont une référence claire.

---

## Acceptance Criteria

1. Ancien code supprimé :
   - Legacy `stripe-webhook-handlers.ts` (ancien monolithe)
   - Legacy `engine.ts` (ancien engine)
   - Legacy `context-builder.ts` (ancien builder)
2. Feature flags retirés (nouveau code par défaut)
3. Documentation complète :
   - Architecture Decision Records (ADRs)
   - Flow diagrams (Mermaid)
   - API documentation (JSDoc complet)
   - Testing guide
   - Troubleshooting guide
4. CHANGELOG.md mis à jour avec breaking changes (aucun normalement)
5. Migration guide pour futurs ajouts de detectors

**Integration Verification** :
- IV1: Aucune référence à ancien code dans codebase
- IV2: Tous les tests passent (nouveau code seulement)
- IV3: Documentation reviewed et approved
- IV4: Onboarding nouveau dev testé avec docs

---

## Tasks / Subtasks

- [ ] **Task 1: Remove Legacy Code** (AC: 1)
  - [ ] Delete `lib/fraud-detection/` (old modules)
  - [ ] Delete old `stripe-webhook-handlers.ts`
  - [ ] Rename `lib/fraud-detection-v2/` → `lib/fraud-detection/`

- [ ] **Task 2: Remove Feature Flags** (AC: 2)
  - [ ] Remove `USE_NEW_ENGINE` flag
  - [ ] Remove `USE_NEW_CONTEXT_BUILDER` flag
  - [ ] Remove `USE_NEW_HANDLERS` flag

- [ ] **Task 3: Complete Documentation** (AC: 3, 5)
  - [ ] **ADRs** : Write 5 ADRs in `docs/architecture/adr/` (see template below)
    - [ ] ADR-001: Strangler Fig Pattern for Refactor
    - [ ] ADR-002: Chain of Responsibility for Detection Pipeline
    - [ ] ADR-003: Trigger.dev for Async AI Processing
    - [ ] ADR-004: In-Memory Cache for Stable Data
    - [ ] ADR-005: Shadow Mode Validation Strategy
  - [ ] **Flow Diagrams** : Create 3 Mermaid diagrams in `docs/architecture/diagrams/`
    - [ ] Webhook Flow (signature → orchestrator → handlers → DB)
    - [ ] Detection Pipeline (context builder → detectors → scoring → decision)
    - [ ] AI Async Flow (webhook → fallback → Trigger.dev → DB update)
  - [ ] **JSDoc** : Complete for all public APIs (run `bun run docs:generate` if available)
  - [ ] **Testing Guide** : Write `docs/testing-guide.md` (see structure below)
  - [ ] **Troubleshooting Guide** : Write `docs/troubleshooting.md` (see structure below)
  - [ ] **Migration Guide** : Write `docs/adding-new-detector.md` (step-by-step guide)

- [ ] **Task 4: Update CHANGELOG** (AC: 4)
  - [ ] Document all changes
  - [ ] Note no breaking changes

---

## Dev Notes

### Files to Delete

```
lib/fraud-detection/
  ├── engine.ts (old)
  ├── context-builder.ts (old)
  └── ... (all old modules)

lib/actions/
  └── stripe-webhook-handlers.ts (old monolith)
```

### Files to Rename

```
lib/fraud-detection-v2/ → lib/fraud-detection/
lib/webhook-handlers-v2/ → lib/webhook-handlers/
```

### Documentation Templates

#### ADR Template (`docs/architecture/adr/TEMPLATE.md`)

```markdown
# ADR-XXX: [Title]

## Status
[Proposed | Accepted | Deprecated | Superseded]

## Context
What is the issue we're trying to solve? What factors are at play?

## Decision
What is the change we're proposing and/or have decided to make?

## Consequences
What becomes easier or more difficult as a result of this change?

### Positive
- Benefit 1
- Benefit 2

### Negative
- Tradeoff 1
- Tradeoff 2

## Alternatives Considered
- Alternative 1: Why rejected
- Alternative 2: Why rejected
```

#### Testing Guide Structure (`docs/testing-guide.md`)

```markdown
# Testing Guide

## Overview
How to run tests, write new tests, and ensure quality.

## Running Tests
- `bun test` - Run all tests
- `bun test:watch` - Watch mode
- `bun test:coverage` - Generate coverage report
- `bun test path/to/test.test.ts` - Run specific test

## Writing Tests

### Unit Tests
- Location: `__tests__/` next to module
- Naming: `*.test.ts`
- Pattern: AAA (Arrange, Act, Assert)

### Integration Tests
- Location: `__tests__/integration/`
- Mock external services (Stripe, DB, OpenAI)
- Use fixtures from `tests/fixtures/`

### Test Patterns
1. Mock Pattern
2. Fixture Pattern
3. Snapshot Pattern (avoid for dynamic data)

## Coverage Targets
- Core Engine: 90%+
- Detectors: 85%+
- Services: 80%+
- Handlers: 75%+

## CI/CD Integration
Tests run automatically on:
- Pull Request
- Push to main
- Pre-commit hook (optional)
```

#### Troubleshooting Guide Structure (`docs/troubleshooting.md`)

```markdown
# Troubleshooting Guide

## Common Issues

### 1. Webhook Signature Verification Failed
**Symptom**: 401 error, "Invalid signature"
**Causes**:
- Webhook secret mismatch
- Request body modified (middleware)
- Stripe CLI secret in dev mode

**Solution**:
1. Verify `STRIPE_WEBHOOK_SECRET` env var
2. Check `rawBody` is used (not parsed JSON)
3. In dev mode, use Stripe CLI secret

### 2. Detection Score Unexpectedly High/Low
**Symptom**: Decision doesn't match expectations
**Causes**:
- Detector priority misconfigured
- Scoring strategy incorrect
- Missing context data

**Solution**:
1. Check detector priorities (lower = first)
2. Review scoring strategy (additive vs weighted)
3. Log `TransactionContext` to verify data

### 3. AI Explanation Not Generated
**Symptom**: `aiExplanation` is fallback text forever
**Causes**:
- Trigger.dev job failed
- OpenAI API key missing
- Rate limit exceeded

**Solution**:
1. Check Trigger.dev dashboard for job status
2. Verify `OPENAI_API_KEY` env var
3. Check OpenAI rate limits

### 4. Cache Not Invalidating
**Symptom**: Stale data after rule update
**Causes**:
- Invalidation not called
- Cache key mismatch
- TTL too long

**Solution**:
1. Verify `cacheService.invalidate()` called
2. Check cache key matches (exact string)
3. Reduce TTL for testing

### 5. Performance Regression
**Symptom**: Webhook latency increased
**Causes**:
- N+1 query problem
- Parallel loading not working
- Cache disabled

**Solution**:
1. Profile DB queries (Drizzle logs)
2. Verify `Promise.all()` for parallel providers
3. Enable cache (`ENABLE_CACHE=true`)

## Debugging Tools

### Logs
```bash
# Filter fraud detection logs
bun run logs | grep "fraud-detection"

# Filter webhook logs
bun run logs | grep "webhook"
```

### Database Queries
```sql
-- Check shadow mode metrics
SELECT * FROM shadow_mode_metrics ORDER BY created_at DESC LIMIT 10;

-- Check fraud detections
SELECT id, decision, risk_score, created_at 
FROM fraud_detections 
WHERE organization_id = 'org_xxx' 
ORDER BY created_at DESC 
LIMIT 10;
```

### Environment Check
```bash
# Verify all required env vars
echo $TRIGGER_API_KEY
echo $OPENAI_API_KEY
echo $STRIPE_WEBHOOK_SECRET
```
```

#### Migration Guide for New Detectors (`docs/adding-new-detector.md`)

```markdown
# Adding a New Detector

## Step 1: Create Detector File
Create `lib/fraud-detection/detectors/my-detector.ts`

## Step 2: Implement IDetector Interface
```typescript
import { IDetector, DetectorResult, TransactionContext } from '../core/interfaces';

export class MyDetector implements IDetector {
  name = 'MyDetector';
  priority = 20; // Lower = higher priority

  canHandle(context: TransactionContext): boolean {
    // Return true if this detector applies
    return context.paymentIntent.amount > 1000;
  }

  async detect(context: TransactionContext): Promise<DetectorResult> {
    const factors: FraudFactor[] = [];
    let score = 0;

    // Your detection logic here
    if (/* condition */) {
      score += 20;
      factors.push({
        type: 'my_factor',
        weight: 20,
        severity: 'medium',
        description: 'Description of risk factor',
        category: 'behavior',
      });
    }

    return {
      detectorName: this.name,
      factors,
      score,
      confidence: 0.8,
    };
  }
}
```

## Step 3: Register Detector
In `lib/fraud-detection/engine.ts`:
```typescript
import { MyDetector } from './detectors/my-detector';

// In engine initialization
engine.registerDetector(new MyDetector());
```

## Step 4: Write Tests
Create `lib/fraud-detection/detectors/__tests__/my-detector.test.ts`

## Step 5: Document
Add JSDoc to detector class and methods.
```

---

## Testing

**Acceptance** :
- All 5 acceptance criteria met
- No legacy code remains
- Documentation complete
- All tests pass

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Story created from PRD | Sarah (PO) |

---
