# Story 2.2: Custom Rules Integration into Fraud Detection Engine

---

## Status

Ready for Review

---

## Story

**As a** fraud detection engine,
**I want** to apply custom rules before system rules,
**so that** merchant-specific rules can override or augment system fraud detection logic.

---

## Acceptance Criteria

1. Integrate `applyCustomRules()` call into `stripe-webhook-handlers.ts` before `detectFraud()` call (ligne ~168)
2. If custom rule matched with `action: "BLOCK"`, skip `detectFraud()` and return BLOCK decision immediately
3. If custom rule matched with `action: "ALLOW"`, merge custom factors with system detection factors
4. If custom rule matched with `action: "REVIEW"`, merge custom factors with system detection factors
5. Combine `FraudFactor[]` from custom rules with system rule factors in final result
6. Custom rule factors are clearly labeled in the output (e.g., "Custom Rule: X")
7. Integration tests verify complete flow: custom rules → system rules → final decision
8. Existing fraud detection functionality unchanged (no regression)

---

## Tasks / Subtasks

- [x] Integrate custom rules into webhook handler (AC: 1)
  - [x] Locate the call to `detectFraud(context)` in `lib/actions/stripe-webhook-handlers.ts` ligne ~169
  - [x] Import `applyCustomRules` from `lib/fraud-detection/custom-rules.ts`
  - [x] Add custom rules check BEFORE `detectFraud()` call (after context building and velocity tracking)
  - [x] Call `applyCustomRules(context, organizationId)` after STEP 2 (velocity tracking) and before STEP 3 (detectFraud)
  - [x] Store custom rule result in variable: `const customRuleResult = await applyCustomRules(context, organizationId)`

- [x] Handle BLOCK action from custom rules (AC: 2)
  - [x] Check if `customRuleResult.decision === "BLOCK"`
  - [x] If true, assign detection result directly (skip `detectFraud()` call):
    - `const detection = { decision: "BLOCK", riskScore: 100, factors: customRuleResult.factors, confidence: "high" }`
  - [x] Skip `detectFraud()` call entirely
  - [x] Continue to STEP 4 (AI explanation) with this custom block decision

- [x] Handle ALLOW and REVIEW actions from custom rules (AC: 3, 4)
  - [x] If `customRuleResult.decision === "ALLOW"` OR `"REVIEW"` OR `null`:
    - [x] Call `detectFraud(context)` normally to get system detection result
    - [x] Store in `let detection = detectFraud(context)`
  - [x] Continue to factor merging step

- [x] Combine factors from custom and system rules (AC: 5, 6)
  - [x] After getting `detection` from `detectFraud()`:
  - [x] If custom rules returned factors, prepend them to detection factors:
    - `detection.factors = [...customRuleResult.factors, ...detection.factors]`
  - [x] Ensure custom rule factors have clear labels (already done in Story 2.1)
  - [x] Maintain factor structure compatibility with existing system
  - [x] Custom rule factors appear first in the final array

- [x] Write integration tests (AC: 7)
  - [x] Create test file: `lib/actions/__tests__/custom-rules-integration.test.ts`
  - [x] Test custom rule BLOCK → `detectFraud()` NOT called
  - [x] Test custom rule ALLOW → `detectFraud()` called
  - [x] Test custom rule REVIEW → `detectFraud()` called → factors merged
  - [x] Test no custom rule match (null decision) → system rules only
  - [x] Test factor combination (custom + system) in correct order

- [x] Verify no regression (AC: 8)
  - [x] Run all existing fraud detection tests (17 tests passing)
  - [x] Verify card testing detection still works
  - [x] Verify velocity checks still work
  - [x] Verify trust score integration unchanged
  - [x] Test with organizations that have no custom rules (behavior identical to before)

---

## Dev Notes

### Relevant Source Tree

**Integration Point:**
- `lib/actions/stripe-webhook-handlers.ts` ligne 169 - before `detectFraud()` call
- Function: `handlePaymentIntentForFraudDetection()`
- Current flow: `buildTransactionContext()` → track attempts → [ADD CUSTOM RULES HERE] → `detectFraud()` → AI explanation

**Dependencies:**
- Story 2.1 `lib/fraud-detection/custom-rules.ts` - Must be completed first
- `lib/fraud-detection/types.ts` - Type definitions
- `lib/fraud-detection/engine.ts` - System rules engine (synchronous)

**Existing Code Context:**
```typescript
// lib/actions/stripe-webhook-handlers.ts ligne ~64-173
export async function handlePaymentIntentForFraudDetection(
  paymentIntent: Stripe.PaymentIntent,
  organizationId: string,
  stripeClient: Stripe
) {
  // STEP 1: Build transaction context
  const context = await buildTransactionContext(
    paymentIntent,
    charge,
    organizationId,
    stripeClient
  );

  // STEP 2: Track payment attempt and update velocity
  // ... (lines 111-166)

  // ⚠️ ADD CUSTOM RULES CHECK HERE (before detectFraud) ⚠️
  // 1. Call applyCustomRules(context, organizationId)
  // 2. Handle BLOCK → skip detectFraud, return immediately
  // 3. Handle ALLOW → merge factors into detection result
  // 4. Handle REVIEW → merge factors into detection result

  // STEP 3: Rules-based detection (synchronous)
  const detection = detectFraud(context);

  console.log(
    `[Fraud] Decision: ${detection.decision}, Score: ${detection.riskScore}`
  );

  // STEP 4: Generate AI explanation
  // ...
}
```

**Why not integrate in engine.ts?**
- `detectFraud()` is currently **synchronous** (no async)
- `applyCustomRules()` is **async** (DB queries)
- Making `detectFraud()` async would be a breaking change
- Safer to integrate in webhook handler before calling `detectFraud()`

**Existing Patterns to Follow:**
- `detectFraud()` is synchronous - takes context, returns result
- `FraudDetectionResult` type with `decision`, `riskScore`, `factors`, `confidence`
- Factor merging: spread operator to combine arrays
- Conditional detection: only call `detectFraud()` if not blocked by custom rule
- Continue webhook flow even if custom rule blocks (no early return from entire handler)

**Integration Logic:**
```typescript
// In handlePaymentIntentForFraudDetection(), after STEP 2 (velocity tracking):

// STEP 2.5: Apply custom rules
const customRuleResult = await applyCustomRules(context, organizationId);

let detection: FraudDetectionResult;

// BLOCK: Skip system detection entirely
if (customRuleResult.decision === "BLOCK") {
  detection = {
    decision: "BLOCK",
    riskScore: 100,
    factors: customRuleResult.factors,
    confidence: "high",
  };
  console.log(`[Fraud] Blocked by custom rule, skipping system detection`);
} else {
  // STEP 3: Rules-based detection (system rules)
  detection = detectFraud(context);

  // Merge custom rule factors if any
  if (customRuleResult.factors.length > 0) {
    detection.factors = [...customRuleResult.factors, ...detection.factors];
    console.log(`[Fraud] Merged ${customRuleResult.factors.length} custom rule factors with system detection`);
  }
}

console.log(
  `[Fraud] Decision: ${detection.decision}, Score: ${detection.riskScore}`
);

// Continue to STEP 4: AI explanation...
```

**Critical Constraints:**
- Custom rules MUST be checked BEFORE `detectFraud()` call
- BLOCK action from custom rule MUST skip `detectFraud()` entirely
- ALLOW/REVIEW actions should NOT modify risk score, just merge factors (system detection is authoritative)
- Factor labels must clearly indicate "Custom Rule" origin (already handled in Story 2.1)
- Backwards compatible with organizations without custom rules (returns `{ decision: null, factors: [] }`)
- Webhook handler must continue processing even if custom rule blocks (save to DB, generate explanation)

**Integration Flow:**
```
1. buildTransactionContext() → context
2. Track payment attempt & update velocity → context.velocity updated
3. applyCustomRules(context, organizationId) → customRuleResult
4. IF customRuleResult.decision === "BLOCK":
   - Skip detectFraud()
   - Use custom rule result as detection
5. ELSE (ALLOW, REVIEW, or null):
   - Call detectFraud(context) → detection
   - Merge customRuleResult.factors into detection.factors
6. Continue to AI explanation
7. Save fraud detection to DB
8. Return result
```

### Testing

**Test Framework:** Vitest

**Test File Location:** `lib/fraud-detection/__tests__/engine.test.ts` (extend existing tests)

**Testing Standards:**
- Integration tests must test complete flow from context building to final decision
- Mock `applyCustomRules()` to return different decisions
- Verify risk score calculations are correct
- Verify factor combinations are correct
- Test all three custom rule actions (BLOCK, ALLOW, REVIEW)

**Test Coverage Requirements:**
- All new code paths covered
- Regression tests for existing fraud detection
- Test edge cases: no custom rules, multiple factors

**Test Scenarios:**
1. Custom BLOCK rule → `detectFraud()` NOT called, immediate block decision
2. Custom ALLOW rule → `detectFraud()` called, factors merged, system detection authoritative
3. Custom REVIEW rule → `detectFraud()` called, factors merged, system detection authoritative
4. No custom rule match (null) → system rules only (existing behavior identical)
5. Custom factors + system factors → factors array has custom first, then system
6. Verify `detectFraud()` mock: called 0 times for BLOCK, called 1 time for ALLOW/REVIEW/null

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 2 | Sarah (Product Owner) |
| 2026-01-08 | 1.1 | Fixed architecture: integration point moved from engine.ts to webhook handler, corrected detectFraud signature (synchronous), clarified factor merging logic | Sarah (Product Owner) |
| 2026-01-08 | 1.2 | Implementation complete: Custom rules integrated into webhook handler with conditional detection and factor merging | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (2026-01-08)

### Debug Log References

No critical issues during implementation.

### Completion Notes List

- Integrated custom rules check before system detection in `handlePaymentIntentCreated()`
- Implemented conditional logic: BLOCK skips system detection, others merge factors
- Created 5 focused unit tests verifying integration logic  
- All tests passing, regression tests confirmed working

### File List

**Modified:**
- `lib/actions/stripe-webhook-handlers.ts` - Added custom rules integration before detectFraud()

**Created:**
- `lib/actions/__tests__/custom-rules-integration.test.ts` - Unit tests for custom rules integration logic

---

## QA Results

_To be filled by QA agent_
