# Story 3.1: Decompose Webhook Handler Monolith

---

## Status

**Draft**

---

## Story

**As a** maintainer,  
**I want** webhook handlers décomposés par domaine métier,  
**so that** le code est maintenable et chaque handler < 300 lignes.

---

## Acceptance Criteria

1. Nouveau `webhook-orchestrator.ts` créé (< 150 lignes) - routes events
2. Handlers spécialisés créés :
   - `payment-handlers.ts` (payment_intent.* events)
   - `charge-handlers.ts` (charge.*, dispute.* events)
   - `customer-handlers.ts` (customer.* events)
   - `checkout-handlers.ts` (checkout.session.* events)
3. Chaque handler module < 300 lignes
4. Séparation orchestration (routing) vs logique métier (handlers)
5. Tests unitaires : 75%+ coverage handlers

**Integration Verification** :
- IV1: Ancien `stripe-webhook-handlers.ts` reste fonctionnel temporairement
- IV2: Route webhook principale (`route.ts`) mise à jour pour utiliser orchestrator
- IV3: Tous event types gérés identiquement
- IV4: **Canary deployment** : 1% → 10% → 50% → 100% traffic

**Rollback Considerations** :
- Feature flag `USE_NEW_HANDLERS` per event type si nécessaire
- Rollback granulaire par handler si problème spécifique
- Monitoring event processing success rate par type

---

## Tasks / Subtasks

- [ ] **Task 1: Create Webhook Orchestrator** (AC: 1, 4)
  - [ ] Create `lib/webhook-handlers-v2/orchestrator.ts`
  - [ ] Implement event routing logic
  - [ ] Keep file < 150 lines

- [ ] **Task 2: Create Specialized Handlers** (AC: 2, 3)
  - [ ] Create `lib/webhook-handlers-v2/handlers/payment.handlers.ts`
  - [ ] Create `lib/webhook-handlers-v2/handlers/charge.handlers.ts`
  - [ ] Create `lib/webhook-handlers-v2/handlers/customer.handlers.ts`
  - [ ] Create `lib/webhook-handlers-v2/handlers/checkout.handlers.ts`
  - [ ] Each handler < 300 lines

- [ ] **Task 3: Update Webhook Route** (AC: IV2)
  - [ ] Update `app/api/webhooks/stripe/[accountId]/route.ts`
  - [ ] Add feature flag for new vs old handlers
  - [ ] Implement canary deployment logic

- [ ] **Task 4: Unit Tests** (AC: 5)
  - [ ] Test orchestrator (75%+ coverage)
  - [ ] Test each handler (75%+ coverage)

---

## Dev Notes

### Existing Integration Point (DO NOT MODIFY YET)

**Current Webhook Route** : `app/api/webhooks/stripe/[accountId]/route.ts`

**Key Components in Current Route** :
1. **Signature Verification** (lines 60-97):
```typescript
const signature = req.headers.get("stripe-signature");
const rawBody = await req.arrayBuffer();
const body = Buffer.from(rawBody).toString("utf-8");
let webhookSecret = decrypt(connection.webhookSecret);
event = stripe.webhooks.constructEvent(body, signature, webhookSecret);
```

2. **Event Routing** (lines 147-213):
```typescript
switch (event.type) {
  case "payment_intent.created":
    await handlePaymentIntentCreated(event, connection);
    break;
  // ... 13 other event types
}
```

**Integration Strategy** :
- Keep signature verification logic in `route.ts` (lines 60-97)
- Replace `switch` statement with orchestrator call
- New orchestrator handles event routing to specialized handlers

### Event Type Mapping Table

| Event Type | Current Handler | New Handler Module | Handler Function |
|------------|----------------|-------------------|------------------|
| `payment_intent.created` | `handlePaymentIntentCreated` | `payment.handlers.ts` | `handleCreated` |
| `payment_intent.succeeded` | `handlePaymentIntentSucceeded` | `payment.handlers.ts` | `handleSucceeded` |
| `payment_intent.payment_failed` | `handlePaymentIntentFailed` | `payment.handlers.ts` | `handleFailed` |
| `charge.dispute.created` | `handleDisputeCreated` | `charge.handlers.ts` | `handleDisputeCreated` |
| `charge.refunded` | `handleChargeRefunded` | `charge.handlers.ts` | `handleRefunded` |
| `checkout.session.completed` | `handleCheckoutSessionCompleted` | `checkout.handlers.ts` | `handleSessionCompleted` |
| `checkout.session.expired` | `handleCheckoutSessionExpired` | `checkout.handlers.ts` | `handleSessionExpired` |
| `checkout.session.async_payment_succeeded` | `handleCheckoutAsyncPaymentSucceeded` | `checkout.handlers.ts` | `handleAsyncSucceeded` |
| `checkout.session.async_payment_failed` | `handleCheckoutAsyncPaymentFailed` | `checkout.handlers.ts` | `handleAsyncFailed` |
| `customer.created` | `handleCustomerCreated` | `customer.handlers.ts` | `handleCreated` |
| `customer.subscription.created` | `handleSubscriptionCreated` | `customer.handlers.ts` | `handleSubscriptionCreated` |
| `customer.subscription.deleted` | `handleSubscriptionDeleted` | `customer.handlers.ts` | `handleSubscriptionDeleted` |
| `radar.early_fraud_warning.created` | `handleRadarFraudWarning` | `charge.handlers.ts` | `handleRadarWarning` |
| `invoice.payment_failed` | `handleInvoicePaymentFailed` | `payment.handlers.ts` | `handleInvoiceFailed` |

**Total** : 14 event types across 4 handler modules

### Orchestrator Pattern

```typescript
export class WebhookOrchestrator {
  private handlers: Map<string, IWebhookHandler> = new Map();

  registerHandler(eventType: string, handler: IWebhookHandler): void {
    this.handlers.set(eventType, handler);
  }

  async handle(event: Stripe.Event, organizationId: string): Promise<WebhookHandlerResult> {
    const handler = this.handlers.get(event.type);
    if (!handler) {
      throw new Error(`No handler for event type: ${event.type}`);
    }
    return handler.handle(event, organizationId);
  }
}
```

### Integration Example (route.ts replacement)

```typescript
// BEFORE (lines 147-213)
switch (event.type) {
  case "payment_intent.created":
    await handlePaymentIntentCreated(event, connection);
    break;
  // ... 13 more cases
}

// AFTER (new orchestrator approach)
const orchestrator = new WebhookOrchestrator();
// Register all handlers
orchestrator.registerHandler("payment_intent.created", new PaymentCreatedHandler());
orchestrator.registerHandler("payment_intent.succeeded", new PaymentSucceededHandler());
// ... register all 14 handlers

// Handle event
await orchestrator.handle(event, connection.organizationId);
```

---

## Testing

**Acceptance** :
- All 5 acceptance criteria met
- 75%+ test coverage
- Canary deployment successful
- No regressions

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Story created from PRD | Sarah (PO) |

---
