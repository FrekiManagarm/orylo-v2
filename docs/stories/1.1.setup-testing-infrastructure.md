# Story 1.1: Setup Testing Infrastructure

---

## Status

**Draft**

---

## Story

**As a** developer,  
**I want** a complete testing infrastructure with Vitest and mocks,  
**so that** I can write tests for nouveau code dès le début.

---

## Acceptance Criteria

1. Vitest configuré avec coverage reporting (v8)
2. Mocks créés pour Stripe, DB (Drizzle), OpenAI
3. Fixtures de test pour TransactionContext, PaymentIntent, Charge
4. Scripts package.json : `bun test`, `bun test:watch`, `bun test:coverage`
5. CI/CD configuré pour exécuter tests automatiquement
6. Documentation des patterns de testing (README tests)

**Integration Verification** :
- IV1: Tests existants ne sont PAS requis (code legacy as-is)
- IV2: Nouveau code doit avoir tests dès création
- IV3: Mock Stripe retourne données réalistes (basées sur Stripe docs)

---

## Tasks / Subtasks

- [ ] **Task 1: Install Vitest and Testing Libraries** (AC: 1, 4)
  - [ ] Run `bun add -D vitest @vitest/ui @testing-library/react @testing-library/jest-dom`
  - [ ] Create `vitest.config.ts` with coverage configuration (v8 provider)
  - [ ] Create `vitest.setup.ts` for global test setup
  - [ ] Add scripts to `package.json`: `test`, `test:watch`, `test:coverage`

- [ ] **Task 2: Create Mock Implementations** (AC: 2)
  - [ ] Create `tests/mocks/stripe.mock.ts` with Stripe SDK mocks
  - [ ] Create `tests/mocks/db.mock.ts` with Drizzle ORM mocks
  - [ ] Create `tests/mocks/openai.mock.ts` with OpenAI API mocks
  - [ ] Ensure mocks return realistic data (based on Stripe/OpenAI docs)

- [ ] **Task 3: Create Test Fixtures** (AC: 3)
  - [ ] Create `tests/fixtures/transaction-context.fixture.ts`
  - [ ] Create `tests/fixtures/payment-intent.fixture.ts`
  - [ ] Create `tests/fixtures/charge.fixture.ts`
  - [ ] Create `tests/fixtures/fraud-detection-result.fixture.ts`

- [ ] **Task 4: Configure CI/CD** (AC: 5)
  - [ ] Add test step to GitHub Actions workflow (if exists)
  - [ ] Configure Vercel to run tests on PR
  - [ ] Setup coverage reporting (Codecov or similar)

- [ ] **Task 5: Document Testing Patterns** (AC: 6)
  - [ ] Create `tests/README.md` with testing guidelines
  - [ ] Document mock usage patterns
  - [ ] Document fixture usage patterns
  - [ ] Add examples of unit and integration tests

---

## Dev Notes

### Relevant Architecture Information

**From `docs/architecture.md` - Testing Strategy Section** :

**Test Framework** : Vitest v2.1.0
- Native TypeScript + ESM support
- 10-20x faster than Jest
- Excellent DX with UI mode
- Compatible with Testing Library ecosystem

**Test Organization** : Colocation pattern
- `__tests__/` folder next to each module
- Example: `lib/fraud-detection-v2/core/engine.ts` → `lib/fraud-detection-v2/core/__tests__/engine.test.ts`

**Coverage Targets** :
- Core Engine: 90%+
- Detectors: 85%+ each
- Services: 80%+
- Handlers: 75%+

**Mock Strategy** :
```typescript
// Stripe Mock Example
export const createStripeMock = () => ({
  paymentIntents: {
    retrieve: vi.fn(),
    cancel: vi.fn(),
  },
  charges: {
    retrieve: vi.fn(),
  },
});

// DB Mock Example
export const createDbMock = () => ({
  query: {
    fraudDetections: {
      findMany: vi.fn(),
      findFirst: vi.fn(),
    },
  },
  insert: vi.fn().mockReturnValue({
    values: vi.fn().mockReturnValue({
      returning: vi.fn(),
    }),
  }),
});
```

### Tech Stack

**Package Manager** : **Bun 1.2.3** (CRITICAL - always use `bun`, never npm/yarn/pnpm)

**New Dependencies to Install** :
- `vitest` ^2.1.0
- `@vitest/ui` ^2.1.0
- `@testing-library/react` ^16.0.0
- `@testing-library/jest-dom` ^6.6.0

**Dependency Conflict Strategy** :
- After installing test dependencies, run `bun install` to verify no conflicts
- If conflicts arise, Bun will resolve automatically or prompt for resolution
- Verify `bun.lockb` updates correctly
- Run `bun run build` to ensure TypeScript compilation still works
- Test that existing code still runs: `bun run dev` should start without errors

### Source Tree

**New Files to Create** :
```
orylo-v2/
├── vitest.config.ts              # Vitest configuration
├── vitest.setup.ts               # Test setup file
├── tests/                        # Global test utilities
│   ├── README.md                 # Testing documentation
│   ├── mocks/
│   │   ├── stripe.mock.ts
│   │   ├── db.mock.ts
│   │   └── openai.mock.ts
│   ├── fixtures/
│   │   ├── transaction-context.fixture.ts
│   │   ├── payment-intent.fixture.ts
│   │   ├── charge.fixture.ts
│   │   └── fraud-detection-result.fixture.ts
│   └── utils/
│       └── test-helpers.ts
└── package.json                  # Update with test scripts
```

### Testing Standards

**Test File Location** : 
- Global mocks/fixtures: `tests/mocks/`, `tests/fixtures/`
- Module-specific tests: `__tests__/` next to each module

**Test Standards** :
- Use Vitest `describe`, `it`, `expect`, `vi` (mocking)
- Use `beforeEach` for test setup
- Use `afterEach` for cleanup
- Mock external dependencies (Stripe, DB, OpenAI)

**Testing Frameworks and Patterns** :
- **Unit Tests** : Test individual functions/classes in isolation
- **Integration Tests** : Test module interactions (e.g., engine + detectors)
- **Mocking** : Use `vi.fn()` for function mocks, `vi.mock()` for module mocks

**Vitest Configuration Example** :
```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./vitest.setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['node_modules/', 'dist/', '**/*.test.ts'],
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './'),
    },
  },
});
```

### Specific Testing Requirements

1. **Stripe Mock** : Must return realistic data matching Stripe API v2024-12-18.2
2. **DB Mock** : Must match Drizzle ORM query builder API
3. **OpenAI Mock** : Must return realistic completion responses
4. **Fixtures** : Must represent valid production-like data
5. **Coverage** : Run `bun run test:coverage` to verify setup works

### Critical Integration Rules

**From Architecture - Coding Standards** :

1. **Never use npm/yarn/pnpm** : Always use `bun` for package management
2. **TypeScript Strict Mode** : All code must compile with strict mode
3. **No `any` types** : Use proper TypeScript types
4. **JSDoc for public APIs** : Document all exported functions/classes

---

## Testing

### Test Requirements for This Story

**Unit Tests** :
- Test that Vitest configuration loads correctly
- Test that mocks can be imported and used
- Test that fixtures return valid data

**Integration Tests** :
- Run `bun test` and verify it executes
- Run `bun test:coverage` and verify coverage report generates
- Verify CI/CD runs tests automatically

**Acceptance** :
- All 6 acceptance criteria met
- Coverage reporting works (even if 0% initially)
- Mocks return realistic data
- Documentation is clear and complete

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_This section will be populated by QA Agent after story completion._

---
