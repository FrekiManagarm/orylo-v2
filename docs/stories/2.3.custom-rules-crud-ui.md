# Story 2.3: Custom Rules CRUD and UI Management

---

## Status

Draft

---

## Story

**As a** merchant user,
**I want** a complete UI to create, view, edit, and delete custom fraud detection rules,
**so that** I can customize fraud detection to my specific business needs without technical knowledge.

---

## Acceptance Criteria

1. Complete CRUD Server Actions in `lib/actions/rules.ts`: `createRule()`, `updateRule()`, `deleteRule()`, `getRules()`
2. Each Server Action has strict Zod validation for rule data
3. UI in `components/dashboard/pages/rules-page.tsx` displays list of rules with status (active/inactive)
4. UI provides form to create new rule with type selection (whitelist, blacklist, amount, country)
5. UI allows editing existing rules (name, description, conditions, action, priority)
6. UI allows activating/deactivating rules without deletion
7. UI shows preview of rule logic before saving
8. E2E tests verify complete flow: create rule → apply in detection → verify result
9. UI follows existing Shadcn/ui design patterns

---

## Tasks / Subtasks

- [ ] Complete CRUD Server Actions in `lib/actions/rules.ts` (AC: 1, 2)
  - [ ] Implement `createRule()`:
    - Signature: `async function createRule(organizationId: string, ruleData: NewFraudDetectionRule): Promise<{ success: boolean; ruleId?: string; error?: string }>`
    - Validate with Zod schema (`fraudDetectionRuleInsertSchema`)
    - Insert into `fraudDetectionRules` table
    - Return rule ID on success
  - [ ] Implement `updateRule()`:
    - Signature: `async function updateRule(ruleId: string, organizationId: string, updates: Partial<FraudDetectionRule>): Promise<{ success: boolean; error?: string }>`
    - Validate organization owns the rule
    - Validate updates with Zod
    - Update in database
  - [ ] Implement `deleteRule()`:
    - Signature: `async function deleteRule(ruleId: string, organizationId: string): Promise<{ success: boolean; error?: string }>`
    - Validate organization owns the rule
    - Soft delete or hard delete (soft recommended)
  - [ ] Implement `getRules()`:
    - Signature: `async function getRules(organizationId: string): Promise<FraudDetectionRule[]>`
    - Fetch all rules for organization
    - Order by priority

- [ ] Create Zod validation schemas (AC: 2)
  - [ ] Schema for whitelist rule: validate emails, IPs, card fingerprints
  - [ ] Schema for blacklist rule: validate emails, IPs, card fingerprints
  - [ ] Schema for amount threshold: validate min/max amounts, currency
  - [ ] Schema for country block: validate ISO country codes
  - [ ] Validate `action` is one of: "ALLOW", "BLOCK", "REVIEW"
  - [ ] Validate `priority` is integer between 1-1000

- [ ] Improve `components/dashboard/pages/rules-page.tsx` UI (AC: 3, 4, 5, 6, 7, 9)
  - [ ] Display rules in table with columns: Name, Type, Action, Priority, Status, Actions
  - [ ] Add "Create Rule" button to open dialog
  - [ ] Create rule form dialog with:
    - Rule name and description inputs
    - Type selector (dropdown: whitelist, blacklist, amount, country)
    - Conditions input (dynamic based on type)
    - Action selector (ALLOW, BLOCK, REVIEW)
    - Priority number input
  - [ ] Add edit button per rule → opens dialog with pre-filled form
  - [ ] Add activate/deactivate toggle per rule
  - [ ] Add delete button per rule (with confirmation)
  - [ ] Show rule preview before saving (e.g., "Block if customer email in [xxx@yyy.com]")

- [ ] Implement rule preview logic (AC: 7)
  - [ ] Create `previewRuleLogic()` function that generates human-readable description
  - [ ] Examples:
    - Whitelist: "Allow payments from customer@example.com"
    - Blacklist: "Block payments from IP 192.168.1.1"
    - Amount: "Review payments above €500"
    - Country: "Block payments from countries: US, CA"
  - [ ] Display preview in dialog before user confirms

- [ ] Write E2E tests (AC: 8)
  - [ ] Test create rule → save → verify in database
  - [ ] Test edit rule → update → verify changes
  - [ ] Test activate/deactivate rule → verify `isActive` flag
  - [ ] Test delete rule → verify removed
  - [ ] Test rule application in fraud detection:
    - Create blacklist rule for test email
    - Simulate payment from that email
    - Verify payment is blocked
  - [ ] Use Playwright or similar for E2E

- [ ] Verify UI follows design patterns (AC: 9)
  - [ ] Use Shadcn/ui components: Dialog, Button, Input, Select, Table
  - [ ] Follow dark mode theme with gradients
  - [ ] Use consistent spacing and typography
  - [ ] Responsive design (mobile, tablet, desktop)

---

## Dev Notes

### Relevant Source Tree

**Files to Modify:**
- `lib/actions/rules.ts` - Complete CRUD Server Actions (partial implementation exists)
- `components/dashboard/pages/rules-page.tsx` - Improve UI (basic UI exists)

**Dependencies:**
- `lib/db/schemas/fraudDetectionRules.ts` - Existing schema and Zod schemas
- `components/ui/dialog.tsx`, `button.tsx`, `input.tsx`, `select.tsx`, `table.tsx` - Shadcn components
- `lib/auth/auth.server.ts` - Session validation for Server Actions

**Existing Partial Implementation:**
```typescript
// lib/actions/rules.ts (partial)
"use server";

import { db } from "@/lib/db";
import { fraudDetectionRules } from "@/lib/db/schemas/fraudDetectionRules";
import { auth } from "@/lib/auth/auth.server";
import { headers } from "next/headers";

// TODO: Complete these functions
export async function createRule() { /* ... */ }
export async function updateRule() { /* ... */ }
export async function deleteRule() { /* ... */ }
export async function getRules() { /* ... */ }
```

**Existing UI:**
```typescript
// components/dashboard/pages/rules-page.tsx
// Basic table exists, needs form dialog and edit/delete actions
```

**Existing Patterns to Follow:**
- Server Actions: `"use server"` directive, session validation, organization isolation
- Zod validation: Use `fraudDetectionRuleInsertSchema` from schema file
- UI patterns: Use `<CreateRuleDialog>` component pattern similar to `<CreateOrganizationDialog>`
- Form handling: Use TanStack Form or simple React state
- Toasts: Use Sonner for success/error notifications

**Zod Validation Example:**
```typescript
import { z } from "zod";

const whitelistConditionsSchema = z.object({
  type: z.literal("whitelist"),
  emails: z.array(z.string().email()).optional(),
  ips: z.array(z.string().ip()).optional(),
  cardFingerprints: z.array(z.string()).optional(),
});

const createRuleSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().max(500).optional(),
  type: z.enum(["whitelist", "blacklist", "amount_threshold", "country_block"]),
  conditions: z.union([
    whitelistConditionsSchema,
    blacklistConditionsSchema,
    amountThresholdConditionsSchema,
    countryBlockConditionsSchema,
  ]),
  action: z.enum(["ALLOW", "BLOCK", "REVIEW"]),
  priority: z.number().int().min(1).max(1000),
});
```

**UI Component Structure:**
```typescript
// components/dashboard/pages/rules-page.tsx
export default function RulesPage() {
  const [rules, setRules] = useState<FraudDetectionRule[]>([]);
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  
  return (
    <div>
      <div className="flex justify-between">
        <h1>Custom Rules</h1>
        <Button onClick={() => setCreateDialogOpen(true)}>Create Rule</Button>
      </div>
      
      <Table>
        {/* Rules list */}
      </Table>
      
      <CreateRuleDialog
        open={createDialogOpen}
        onClose={() => setCreateDialogOpen(false)}
        onSuccess={handleRuleCreated}
      />
    </div>
  );
}
```

**Critical Constraints:**
- Plan limits: Free = 0 rules, Pro = 3 rules, Business = unlimited
- Validate plan before allowing rule creation
- Multi-tenant: Always filter by `organizationId`
- Soft delete recommended (add `deletedAt` field) for audit trail
- Rule preview must be human-readable (non-technical users)

### Testing

**Test Framework:** Vitest for Server Actions, Playwright for E2E

**Test File Locations:**
- `lib/actions/__tests__/rules.test.ts` - Unit tests for CRUD
- `e2e/rules.spec.ts` - E2E tests for complete flow

**Testing Standards:**
- Unit tests: Mock database, test validation, test authorization
- E2E tests: Test complete user flow from UI to fraud detection
- Test plan limits (Free user cannot create rules)
- Test organization isolation (user cannot edit other org's rules)

**Test Coverage Requirements:**
- All CRUD operations covered
- All validation schemas tested
- E2E flow: create → detect → verify

**Test Scenarios:**
1. Create whitelist rule → payment from whitelisted email → allowed
2. Create blacklist rule → payment from blacklisted IP → blocked
3. Create amount threshold → payment above threshold → reviewed
4. Edit rule → updated conditions → verify changes applied
5. Deactivate rule → rule no longer applied in detection
6. Delete rule → rule removed from database
7. Plan limit: Free user attempts to create rule → error

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 2 | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
