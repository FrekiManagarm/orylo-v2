# Story 4.2: AI Explanation Display Improvement in Dashboard

---

## Status

Draft

---

## Story

**As a** merchant user,
**I want** improved visual presentation of AI fraud explanations in the dashboard,
**so that** I can quickly understand fraud decisions and take appropriate action.

---

## Acceptance Criteria

1. Improve Markdown rendering in `components/dashboard/pages/transactions-page.tsx`
2. Add syntax highlighting for important sections (Card Testing, Risk Factors)
3. Add tooltips for technical metrics (risk score, trust score, etc.)
4. Improve typography for better readability (headings, spacing, colors)
5. Add visual indicators for severity levels (ðŸ”´ critical, ðŸŸ¡ medium, ðŸŸ¢ low)
6. Ensure responsive design (mobile, tablet, desktop)
7. Test rendering with different explanation types
8. Maintain existing Shadcn/ui design patterns and dark theme

---

## Tasks / Subtasks

- [ ] Improve Markdown rendering component (AC: 1, 4)
  - [ ] Locate AI explanation rendering in `components/dashboard/pages/transactions-page.tsx`
  - [ ] Install Markdown library if not present: `bun add react-markdown remark-gfm`
  - [ ] Create custom Markdown component with styled elements:
    - `h2` â†’ Large bold text with bottom border
    - `h3` â†’ Medium bold text with indigo color
    - `ul`, `ol` â†’ Proper spacing and bullets
    - `strong` â†’ Bold with purple accent
    - `code` â†’ Zinc-800 background with monospace font
  - [ ] Use Tailwind classes for consistent styling

- [ ] Add section highlighting (AC: 2)
  - [ ] Detect section headers in Markdown (## Analyse Card Testing, ## Facteurs de Risque)
  - [ ] Apply colored backgrounds or borders:
    - "Analyse Card Testing" â†’ Red/orange accent
    - "Facteurs de Risque" â†’ Amber accent
    - "Recommandation" â†’ Green/blue accent
  - [ ] Use gradients consistent with Orylo theme

- [ ] Add tooltips for technical metrics (AC: 3)
  - [ ] Identify technical terms in explanations (risk score, trust score, velocity, BIN)
  - [ ] Wrap in `<Tooltip>` component from Shadcn/ui
  - [ ] Tooltip content explains term in simple language:
    - "Risk Score" â†’ "Score de 0 Ã  100 indiquant le niveau de risque de fraude"
    - "Trust Score" â†’ "Score de confiance basÃ© sur l'historique du customer"
    - "Velocity" â†’ "Nombre de transactions dans une pÃ©riode donnÃ©e"
  - [ ] Use regex or custom parser to auto-wrap technical terms

- [ ] Add severity visual indicators (AC: 5)
  - [ ] Parse risk factors from AI explanation
  - [ ] Detect severity level (critical, medium, low) from emoji or keyword
  - [ ] Apply color coding:
    - ðŸ”´ Critical â†’ Red text with red dot
    - ðŸŸ¡ Medium â†’ Amber text with amber dot
    - ðŸŸ¢ Low â†’ Green text with green dot
  - [ ] Ensure emojis render correctly across browsers

- [ ] Improve typography and spacing (AC: 4)
  - [ ] Increase line height for better readability: `leading-relaxed`
  - [ ] Add proper spacing between sections: `space-y-4`
  - [ ] Use consistent font sizes:
    - h2: `text-2xl`
    - h3: `text-xl`
    - Body: `text-base`
    - Code: `text-sm`
  - [ ] Ensure contrast ratios meet accessibility standards (WCAG AA)

- [ ] Ensure responsive design (AC: 6)
  - [ ] Test on mobile viewport (< 768px)
  - [ ] Adjust font sizes for mobile: smaller headings, same body text
  - [ ] Ensure horizontal scrolling not required
  - [ ] Test on tablet viewport (768px - 1024px)
  - [ ] Verify layout adapts correctly

- [ ] Test with different explanation types (AC: 7)
  - [ ] Test with card testing explanation â†’ verify highlighting works
  - [ ] Test with velocity explanation â†’ verify metrics display correctly
  - [ ] Test with trust score explanation â†’ verify tooltips work
  - [ ] Test with multi-factor explanation â†’ verify factor list readable
  - [ ] Test with short explanation â†’ verify layout not broken
  - [ ] Test with long explanation â†’ verify scrolling works

- [ ] Maintain design consistency (AC: 8)
  - [ ] Use Shadcn/ui components where applicable (Tooltip, Card)
  - [ ] Follow dark theme: zinc backgrounds, white/gray text
  - [ ] Use brand colors: indigo/purple accents
  - [ ] Ensure consistency with other dashboard pages

---

## Dev Notes

### Relevant Source Tree

**Files to Modify:**
- `components/dashboard/pages/transactions-page.tsx` - Main file with AI explanation display

**New Files to Create (optional):**
- `components/dashboard/markdown-explanation.tsx` - Dedicated component for rendering AI explanations

**Dependencies:**
- `react-markdown` - Markdown rendering library
- `remark-gfm` - GitHub Flavored Markdown support
- `components/ui/tooltip.tsx` - Shadcn Tooltip component
- Story 4.1 - Enhanced AI prompts (provides better structured Markdown)

**Current Implementation:**
```typescript
// components/dashboard/pages/transactions-page.tsx
// Current: Simple Markdown rendering without styling
<div className="prose prose-invert">
  <ReactMarkdown>{aiExplanation}</ReactMarkdown>
</div>
```

**Enhanced Implementation:**
```typescript
// components/dashboard/markdown-explanation.tsx
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";

const technicalTerms = {
  "risk score": "Score de 0 Ã  100 indiquant le niveau de risque de fraude",
  "trust score": "Score de confiance basÃ© sur l'historique du customer",
  "velocity": "Nombre de transactions dans une pÃ©riode donnÃ©e",
  "BIN": "Bank Identification Number - premiers chiffres de la carte",
};

export function MarkdownExplanation({ content }: { content: string }) {
  const processedContent = highlightTechnicalTerms(content);
  
  return (
    <div className="space-y-4">
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        components={{
          h2: ({ children }) => (
            <h2 className="text-2xl font-bold text-white border-b border-white/10 pb-2 mb-4">
              {children}
            </h2>
          ),
          h3: ({ children }) => (
            <h3 className="text-xl font-semibold text-indigo-400 mb-2">
              {children}
            </h3>
          ),
          ul: ({ children }) => (
            <ul className="space-y-2 list-disc list-inside text-zinc-300">
              {children}
            </ul>
          ),
          strong: ({ children }) => (
            <strong className="font-semibold text-purple-400">
              {children}
            </strong>
          ),
          code: ({ children }) => (
            <code className="bg-zinc-800 px-2 py-1 rounded text-sm font-mono text-zinc-300">
              {children}
            </code>
          ),
        }}
      >
        {processedContent}
      </ReactMarkdown>
    </div>
  );
}

function highlightTechnicalTerms(content: string): string {
  // Wrap technical terms in tooltips
  let processed = content;
  Object.entries(technicalTerms).forEach(([term, definition]) => {
    const regex = new RegExp(`\\b${term}\\b`, "gi");
    processed = processed.replace(regex, `<Tooltip term="${term}" definition="${definition}">$&</Tooltip>`);
  });
  return processed;
}
```

**Section Highlighting:**
```typescript
// Detect section and apply styling
const sectionStyles = {
  "Analyse Card Testing": "bg-red-900/20 border-l-4 border-red-500 pl-4",
  "Facteurs de Risque": "bg-amber-900/20 border-l-4 border-amber-500 pl-4",
  "Recommandation": "bg-green-900/20 border-l-4 border-green-500 pl-4",
};
```

**Severity Indicators:**
```typescript
// Parse severity from emoji or keyword
const severityIcons = {
  "ðŸ”´": <span className="inline-block w-2 h-2 rounded-full bg-red-500" />,
  "ðŸŸ¡": <span className="inline-block w-2 h-2 rounded-full bg-amber-500" />,
  "ðŸŸ¢": <span className="inline-block w-2 h-2 rounded-full bg-green-500" />,
};
```

**Existing Patterns to Follow:**
- Shadcn/ui Tooltip component for interactive help
- Dark theme: zinc-900 backgrounds, white/gray text
- Brand colors: indigo-500, purple-500 for accents
- Responsive design: mobile-first with Tailwind breakpoints
- Accessibility: proper ARIA labels, keyboard navigation

**Critical Constraints:**
- Markdown MUST render correctly (no broken formatting)
- Tooltips MUST be accessible (keyboard navigation)
- Performance: rendering should not slow down page load
- Responsive: readable on all screen sizes
- Design consistency: match existing dashboard style

**Accessibility Requirements:**
- Color contrast ratios â‰¥ 4.5:1 (WCAG AA)
- Tooltips accessible via keyboard (Tab navigation)
- Screen reader friendly (proper ARIA labels)
- Focus indicators visible

### Testing

**Test Framework:** Manual visual testing + automated rendering tests

**Testing Standards:**
- Visual testing on multiple browsers (Chrome, Firefox, Safari)
- Responsive testing on different screen sizes
- Accessibility testing with keyboard navigation
- Performance testing (rendering time)

**Test Coverage Requirements:**
- All Markdown elements render correctly
- All tooltips work and are accessible
- All section highlights applied
- Responsive design works on mobile, tablet, desktop

**Test Scenarios:**
1. Card testing explanation â†’ red highlight on "Analyse Card Testing" section
2. Risk factors list â†’ severity icons colored correctly (ðŸ”´ðŸŸ¡ðŸŸ¢)
3. Technical terms â†’ tooltips appear on hover
4. Long explanation â†’ scrolling works, no layout overflow
5. Mobile viewport â†’ text readable, no horizontal scroll
6. Keyboard navigation â†’ tooltips accessible via Tab key
7. Dark theme â†’ colors contrast properly, readable

**Visual Regression Testing:**
- Take screenshots before/after changes
- Compare rendering across browsers
- Verify consistency with design system

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 4 | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
