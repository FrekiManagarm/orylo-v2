# Story 3.2: Email Templates with React Email

---

## Status

Approved

---

## Story

**As a** fraud alert system,
**I want** professional HTML email templates for different alert types,
**so that** users receive well-formatted, branded emails with clear information about fraud events.

---

## Acceptance Criteria

1. Install React Email: `bun add @react-email/components @react-email/render react-email`
2. Create email templates in `lib/email/templates/` directory for three alert types:
   - `fraud-alert-email.tsx` - General fraud detection alert
   - `card-testing-alert-email.tsx` - Card testing attack alert
   - `high-risk-alert-email.tsx` - High-risk transaction alert
3. Each template includes: alert title, severity, transaction details, link to dashboard, branding
4. Templates use React Email components (Container, Section, Text, Button, etc.)
5. Templates follow Orylo brand colors and style (dark theme, indigo/purple gradients)
6. Templates are responsive (mobile-friendly)
7. Test email rendering with React Email dev server
8. Export templates as functions that accept alert data and return HTML string

---

## Tasks / Subtasks

- [ ] Install React Email (AC: 1)
  - [ ] Run `bun add @react-email/components react-email`
  - [ ] Verify packages added to `package.json`
  - [ ] Add React Email dev script to `package.json`: `"email:dev": "email dev"`

- [ ] Create base email layout component (AC: 4, 5, 6)
  - [ ] Create `lib/email/components/email-layout.tsx`
  - [ ] Use `<Container>` from React Email (NOT plain div)
  - [ ] Include Orylo logo and branding
  - [ ] Use brand colors: indigo (#6366f1), purple (#a855f7), zinc backgrounds
  - [ ] Responsive design with mobile-friendly styles
  - [ ] Footer with unsubscribe link (future) and company info

- [ ] Create fraud alert email template (AC: 2, 3)
  - [ ] File: `lib/email/templates/fraud-alert-email.tsx`
  - [ ] Props: `{ alertTitle: string; severity: string; transactionAmount: number; paymentIntentId: string; riskScore: number; dashboardUrl: string }`
  - [ ] Content sections:
    - Header: "‚ö†Ô∏è Alerte Fraude D√©tect√©e"
    - Alert details: title, severity badge
    - Transaction info: amount, payment intent ID, risk score
    - CTA button: "Voir dans le Dashboard"
    - Footer: Orylo branding
  - [ ] Export as function: `export function FraudAlertEmail(props) { return <EmailLayout>...</EmailLayout>; }`

- [ ] Create card testing alert email template (AC: 2, 3)
  - [ ] File: `lib/email/templates/card-testing-alert-email.tsx`
  - [ ] Props: `{ attackDetails: { uniqueCards: number; failedAttempts: number; ipAddress: string; timeWindow: string }; dashboardUrl: string }`
  - [ ] Content sections:
    - Header: "üö® Attaque Card Testing D√©tect√©e"
    - Attack metrics: unique cards, failed attempts, IP, time window
    - Impact summary
    - CTA button: "Bloquer l'IP"
    - Footer
  - [ ] Highlight severity with red/orange colors

- [ ] Create high-risk alert email template (AC: 2, 3)
  - [ ] File: `lib/email/templates/high-risk-alert-email.tsx`
  - [ ] Props: `{ customerEmail: string; transactionAmount: number; riskScore: number; riskFactors: string[]; dashboardUrl: string }`
  - [ ] Content sections:
    - Header: "‚ö†Ô∏è Transaction √† Haut Risque"
    - Customer info: email, amount
    - Risk score with visual indicator (color-coded)
    - Risk factors list
    - CTA button: "Examiner la Transaction"
    - Footer
  - [ ] Amber/yellow colors for warning

- [ ] Create email render utility (AC: 8)
  - [ ] File: `lib/email/render.ts`
  - [ ] Function: `async function renderEmail(template: React.ReactElement): Promise<string>`
  - [ ] Use `render()` from `@react-email/render`
  - [ ] Return HTML string ready for Resend
  - [ ] Export helper functions:
    - `renderFraudAlertEmail(props) ‚Üí HTML string`
    - `renderCardTestingAlertEmail(props) ‚Üí HTML string`
    - `renderHighRiskAlertEmail(props) ‚Üí HTML string`

- [ ] Test email templates (AC: 7)
  - [ ] Run `bun run email:dev` to start React Email dev server
  - [ ] Open `http://localhost:3000` (or configured port)
  - [ ] Preview all three templates with sample data
  - [ ] Test on mobile viewport (responsive design)
  - [ ] Verify all links work
  - [ ] Verify branding is consistent

- [ ] Update `send-alert-email.ts` to use templates (integration)
  - [ ] Import render functions from `lib/email/render.ts`
  - [ ] Replace simple HTML with rendered template based on alert type:
    - `type === "fraud_detected"` ‚Üí `renderFraudAlertEmail()`
    - `type === "card_testing"` ‚Üí `renderCardTestingAlertEmail()`
    - `type === "high_risk"` ‚Üí `renderHighRiskAlertEmail()`
  - [ ] Pass alert data as props to render functions

---

## Dev Notes

### Relevant Source Tree

**New Files to Create:**
- `lib/email/components/email-layout.tsx` - Base layout component
- `lib/email/templates/fraud-alert-email.tsx` - Fraud alert template
- `lib/email/templates/card-testing-alert-email.tsx` - Card testing template
- `lib/email/templates/high-risk-alert-email.tsx` - High-risk template
- `lib/email/render.ts` - Render utility functions

**Existing Files:**
- `lib/email/resend-client.ts` - Resend client (from Story 3.1)

**Dependencies:**
- `@react-email/components` - Email components (Container, Section, Text, Button, Hr, etc.)
- `@react-email/render` - Server-side rendering function
- `react-email` - Dev server for preview
- Story 3.1 `lib/actions/send-alert-email.ts` - Will use these templates

**React Email Components:**
```typescript
import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Preview,
  Section,
  Text,
  Button,
  Hr,
  Img,
} from "@react-email/components";
```

**Base Layout Structure:**
```typescript
// lib/email/components/email-layout.tsx
import React from "react";
import {
  Body,
  Container,
  Head,
  Html,
  Img,
  Preview,
  Text,
  Hr,
} from "@react-email/components";

export function EmailLayout({ children, preview }: { children: React.ReactNode; preview: string }) {
  return (
    <Html>
      <Head />
      <Preview>{preview}</Preview>
      <Body style={{ backgroundColor: "#18181b", fontFamily: "sans-serif" }}>
        <Container style={{ maxWidth: "600px", margin: "0 auto", padding: "20px" }}>
          {/* Orylo logo */}
          <Img src="https://orylo.com/logo.png" alt="Orylo" width="120" />
          
          {/* Content */}
          {children}
          
          {/* Footer */}
          <Hr />
          <Text style={{ color: "#71717a", fontSize: "12px" }}>
            ¬© 2026 Orylo. Tous droits r√©serv√©s.
          </Text>
        </Container>
      </Body>
    </Html>
  );
}
```

**Fraud Alert Template Example:**
```typescript
// lib/email/templates/fraud-alert-email.tsx
import React from "react";
import { Heading, Section, Text, Button } from "@react-email/components";
import { EmailLayout } from "../components/email-layout";

interface FraudAlertEmailProps {
  alertTitle: string;
  severity: string;
  transactionAmount: number;
  paymentIntentId: string;
  riskScore: number;
  dashboardUrl: string;
}

export function FraudAlertEmail({
  alertTitle,
  severity,
  transactionAmount,
  paymentIntentId,
  riskScore,
  dashboardUrl,
}: FraudAlertEmailProps) {
  return (
    <EmailLayout preview="Alerte fraude d√©tect√©e">
      <Heading style={{ color: "#f9fafb" }}>‚ö†Ô∏è Alerte Fraude D√©tect√©e</Heading>
      
      <Section>
        <Text style={{ color: "#e4e4e7" }}>{alertTitle}</Text>
        <Text style={{ color: "#f59e0b" }}>S√©v√©rit√©: {severity}</Text>
      </Section>
      
      <Section>
        <Text style={{ color: "#e4e4e7" }}>Montant: {transactionAmount}‚Ç¨</Text>
        <Text style={{ color: "#a1a1aa" }}>Payment Intent: {paymentIntentId}</Text>
        <Text style={{ color: "#ef4444" }}>Score de risque: {riskScore}/100</Text>
      </Section>
      
      <Button
        href={dashboardUrl}
        style={{
          backgroundColor: "#6366f1",
          color: "#ffffff",
          padding: "12px 24px",
          borderRadius: "6px",
          textDecoration: "none",
        }}
      >
        Voir dans le Dashboard
      </Button>
    </EmailLayout>
  );
}
```

**Render Utility:**
```typescript
// lib/email/render.ts
import React from "react";
import { render } from "@react-email/render";
import { FraudAlertEmail } from "./templates/fraud-alert-email";
import { CardTestingAlertEmail } from "./templates/card-testing-alert-email";
import { HighRiskAlertEmail } from "./templates/high-risk-alert-email";
import type { FraudAlertEmailProps, CardTestingAlertEmailProps, HighRiskAlertEmailProps } from "./templates/types";

export async function renderFraudAlertEmail(props: FraudAlertEmailProps): Promise<string> {
  return await render(<FraudAlertEmail {...props} />);
}

export async function renderCardTestingAlertEmail(props: CardTestingAlertEmailProps): Promise<string> {
  return await render(<CardTestingAlertEmail {...props} />);
}

export async function renderHighRiskAlertEmail(props: HighRiskAlertEmailProps): Promise<string> {
  return await render(<HighRiskAlertEmail {...props} />);
}
```

**Brand Colors:**
- Background: `#18181b` (zinc-900)
- Text: `#f9fafb` (zinc-50)
- Secondary text: `#a1a1aa` (zinc-400)
- Primary (indigo): `#6366f1`
- Secondary (purple): `#a855f7`
- Warning (amber): `#f59e0b`
- Error (red): `#ef4444`

**Critical Constraints:**
- MUST use `<Container>` from React Email (not plain `<div>`)
- Templates MUST be responsive (mobile-first)
- Links MUST be absolute URLs (no relative paths)
- Inline styles MUST be used via `style` prop (email clients don't support external CSS or className)
- Brand colors MUST match Orylo dashboard theme
- MUST use `lib/email/` folder (singular) to stay consistent with existing structure
- MUST import React in all template files

### Testing

**Test Framework:** Manual testing with React Email dev server

**Testing Standards:**
- Visual testing in dev server (`bun run email:dev`)
- Test on multiple email clients (Gmail, Outlook, Apple Mail)
- Test responsive design on mobile viewport
- Verify all links are clickable and go to correct URLs
- Test with realistic data (not lorem ipsum)

**Test Scenarios:**
1. Fraud alert email with high severity ‚Üí red colors, urgent tone
2. Card testing alert with attack metrics ‚Üí clear metrics display
3. High-risk alert with multiple risk factors ‚Üí factors list formatted correctly
4. Mobile viewport ‚Üí responsive layout, readable text
5. Dark mode email clients ‚Üí colors still visible
6. Button clicks ‚Üí navigate to correct dashboard URL

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 3 | Sarah (Product Owner) |
| 2026-01-08 | 1.1 | Fixed folder structure (lib/email/ instead of lib/emails/), clarified render import from @react-email/render, added React imports, added @react-email/render to dependencies | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
