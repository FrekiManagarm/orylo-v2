# Story 2.1: Refactor Context Builder with Parallelization

---

## Status

**Draft**

---

## Story

**As a** system,  
**I want** to build transaction context en parallèle plutôt que séquentiellement,  
**so that** la latence de construction de context est réduite de 40%.

---

## Acceptance Criteria

1. Nouveau `context-builder.service.ts` créé avec interface `IContextBuilderService`
2. Context providers séparés (CustomerProvider, VelocityProvider, CardProvider)
3. Parallel loading avec Promise.all pour providers indépendants
4. Lazy loading : charger seulement contextes nécessaires selon règles actives
5. **Performance** : Baseline établi, nouveau code mesure latence < baseline -30%
6. Tests unitaires : 80%+ coverage context-builder
7. **Shadow mode** : Execute ancien + nouveau, compare, log divergences

**Integration Verification** :
- IV1: Ancien `buildTransactionContext()` reste fonctionnel
- IV2: Nouveau service retourne exactement même structure `TransactionContext`
- IV3: Aucun breaking change dans `handlePaymentIntentCreated()`
- IV4: Performance mesurée : baseline (200ms) → nouveau (< 140ms)

**Rollback Considerations** :
- Feature flag `USE_NEW_CONTEXT_BUILDER` pour activer/désactiver
- Rollback immédiat possible via env var
- Monitoring : alertes si latence > baseline + 50ms

---

## Tasks / Subtasks

- [ ] **Task 1: Create Context Builder Service** (AC: 1)
  - [ ] Create `lib/fraud-detection-v2/services/context-builder.service.ts`
  - [ ] Implement `IContextBuilderService` interface
  - [ ] Add constructor injection for providers

- [ ] **Task 2: Create Context Providers** (AC: 2)
  - [ ] Create `lib/fraud-detection-v2/services/providers/customer.provider.ts`
  - [ ] Create `lib/fraud-detection-v2/services/providers/velocity.provider.ts`
  - [ ] Create `lib/fraud-detection-v2/services/providers/card.provider.ts`
  - [ ] Create `lib/fraud-detection-v2/services/providers/device.provider.ts`
  - [ ] Each provider implements `IContextProvider<T>` interface

- [ ] **Task 3: Implement Parallel Loading** (AC: 3, 4)
  - [ ] Use `Promise.all()` for independent providers
  - [ ] Implement lazy loading logic (load only if needed)
  - [ ] Add performance logging (measure latency per provider)

- [ ] **Task 4: Implement Shadow Mode** (AC: 7)
  - [ ] Add feature flag `USE_NEW_CONTEXT_BUILDER` check
  - [ ] Execute both old and new builders in parallel
  - [ ] Compare results and log divergences
  - [ ] Add structured logging for analysis

- [ ] **Task 5: Performance Testing** (AC: 5, IV4)
  - [ ] Establish baseline (measure current `buildTransactionContext()` latency)
  - [ ] Measure new service latency
  - [ ] Verify improvement >= 30%
  - [ ] Add performance regression tests

- [ ] **Task 6: Unit Tests** (AC: 6)
  - [ ] Test context-builder.service.ts (80%+ coverage)
  - [ ] Test each provider independently
  - [ ] Test parallel loading logic
  - [ ] Test lazy loading logic

---

## Dev Notes

### Relevant Architecture Information

**From `docs/architecture.md` - Component Architecture** :

**IContextBuilderService Interface** :
```typescript
export interface IContextBuilderService {
  build(paymentIntent: Stripe.PaymentIntent, organizationId: string): Promise<TransactionContext>;
  buildParallel(paymentIntent: Stripe.PaymentIntent, organizationId: string): Promise<TransactionContext>;
}

export interface IContextProvider<T> {
  canProvide(paymentIntent: Stripe.PaymentIntent): boolean;
  provide(paymentIntent: Stripe.PaymentIntent, organizationId: string): Promise<T>;
}
```

**Parallel Loading Pattern** :
```typescript
// Execute providers in parallel
const [customerData, velocityData, cardData] = await Promise.all([
  customerProvider.provide(paymentIntent, organizationId),
  velocityProvider.provide(paymentIntent, organizationId),
  cardProvider.provide(paymentIntent, organizationId),
]);
```

**Shadow Mode Pattern** :
```typescript
const useNewBuilder = process.env.USE_NEW_CONTEXT_BUILDER === 'true';

if (process.env.ENABLE_SHADOW_MODE === 'true') {
  const [oldContext, newContext] = await Promise.all([
    buildTransactionContextLegacy(paymentIntent),
    contextBuilderService.buildParallel(paymentIntent, organizationId),
  ]);
  
  // Compare and log divergences
  const divergences = compareContexts(oldContext, newContext);
  if (divergences.length > 0) {
    logger.warn('Context builder divergences detected', { divergences });
  }
  
  return useNewBuilder ? newContext : oldContext;
}

return useNewBuilder 
  ? await contextBuilderService.buildParallel(paymentIntent, organizationId)
  : await buildTransactionContextLegacy(paymentIntent);
```

### Existing Code to Preserve

**DO NOT MODIFY** :
- `lib/fraud-detection/context-builder.ts` - Legacy builder (keep unchanged)
- `lib/fraud-detection/types.ts` - Legacy types (keep unchanged)

**Integration Point** :
- `lib/actions/stripe-webhook-handlers.ts` - `handlePaymentIntentCreated()` function
  - Currently calls `buildTransactionContext()`
  - Will add feature flag to call new or old builder

### Performance Targets

**Baseline (Current)** : ~200ms for context building
**Target (New)** : < 140ms (30% improvement)
**Alert Threshold** : > 250ms (baseline + 50ms)

**Latency Breakdown (Current)** :
- Customer data fetch: ~80ms
- Velocity metrics fetch: ~60ms
- Card data fetch: ~40ms
- Device data fetch: ~20ms
- **Total (sequential)**: ~200ms

**Expected (Parallel)** :
- All providers in parallel: ~80ms (longest provider)
- Overhead: ~20ms
- **Total (parallel)**: ~100-120ms

### Testing Standards

**Test File Location** : `lib/fraud-detection-v2/services/__tests__/context-builder.service.test.ts`

**Test Requirements** :
- Mock all providers (CustomerProvider, VelocityProvider, etc.)
- Test parallel execution (verify Promise.all called)
- Test lazy loading (verify only needed providers called)
- Test shadow mode (verify both builders executed and compared)
- Performance tests (verify latency < baseline -30%)

---

## Testing

### Test Requirements for This Story

**Unit Tests** :
- Test context-builder.service.ts (80%+ coverage)
- Test each provider independently
- Test parallel loading with mocked providers
- Test lazy loading logic

**Integration Tests** :
- Test full context building with real DB queries (test DB)
- Compare old vs new builder results (should be identical)
- Measure performance improvement

**Performance Tests** :
- Baseline measurement: current builder latency
- New builder latency measurement
- Verify >= 30% improvement
- Regression test: alert if latency increases

**Acceptance** :
- All 7 acceptance criteria met
- 80%+ test coverage
- Performance target achieved (< 140ms)
- Shadow mode working correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Story created from PRD | Sarah (PO) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by QA Agent after story completion._

---
