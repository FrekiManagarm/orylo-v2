# Story 1.2: Auto-Refund Integration into Webhook Handler

---

## Status

Ready for Review

---

## Story

**As a** webhook handler,
**I want** to automatically refund fraudulent payments after they succeed,
**so that** merchants are protected from fraud losses even when payments slip through initial detection.

---

## Acceptance Criteria

1. Integrate `autoRefundFraudulentPayment()` call into `handlePaymentIntentSucceeded()` after `updateCustomerScore()`
2. Verify fraud status before calling refund function (`actualOutcome === "fraud_confirmed"` OR retroactive detection)
3. Update `fraudDetections.refundId` with Stripe refund ID after successful refund
4. Update `fraudDetections.actionTaken` to "refunded" after successful refund
5. Create alert notification when refund is executed
6. Handle refund failures gracefully without disrupting webhook processing
7. Integration tests verify complete flow: webhook → fraud detection → refund → DB update
8. Existing webhook functionality remains unchanged (no regression)

---

## Tasks / Subtasks

- [x] Integrate auto-refund into `handlePaymentIntentSucceeded()` (AC: 1, 2)
  - [x] Locate `handlePaymentIntentSucceeded()` in `lib/actions/stripe-webhook-handlers.ts` ligne 399
  - [x] Import `autoRefundFraudulentPayment` from `lib/actions/auto-refund.ts`
  - [x] Extract `organizationId` from connection: `const organizationId = connection.organizationId`
  - [x] Add refund check after `updateCustomerScore()` call
  - [x] Fetch fraud detection record for this payment intent using `db.query.fraudDetections.findFirst({ where: eq(fraudDetections.paymentIntentId, paymentIntent.id) })`
  - [x] Check if refund is needed: `actualOutcome === "fraud_confirmed"` OR (`riskScore >= 80` AND `decision === "BLOCK"` AND payment succeeded)
  - [x] Call `autoRefundFraudulentPayment(paymentIntent.id, organizationId, fraudDetection.id)` if criteria met

- [x] Update fraud detection record after refund (AC: 3, 4)
  - [x] Check if refund was successful (response.success === true)
  - [x] Update `fraudDetections` table with `db.update()`:
    - Set `refundId` to Stripe refund ID
    - Set `actionTaken` to "refunded"
    - Update `updatedAt` timestamp
  - [x] Log successful refund with fraud detection ID and refund ID

- [x] Create alert notification for refund (AC: 5)
  - [x] Create alert in `alerts` table with:
    - `type`: "fraud_refunded"
    - `severity`: "high"
    - `title`: "Paiement frauduleux remboursé automatiquement"
    - `message`: Include payment intent ID, amount, refund ID
    - `data`: Include fraud detection details
  - [x] Use existing alert creation pattern

- [x] Handle refund failures gracefully (AC: 6)
  - [x] Wrap refund logic in try-catch block
  - [x] Log errors without throwing (use `console.error()`)
  - [x] Create alert for failed refund attempts
  - [x] Continue webhook processing even if refund fails
  - [x] Do not update `fraudDetections` if refund failed

- [x] Write integration tests (AC: 7)
  - [x] Test complete flow: `payment_intent.succeeded` → fraud check → refund → DB update
  - [x] Mock Stripe webhook event with fraudulent payment
  - [x] Verify `autoRefundFraudulentPayment()` is called with correct parameters
  - [x] Verify `fraudDetections` table is updated with refund ID
  - [x] Verify alert is created
  - [x] Test error handling when refund fails

- [x] Verify no regression in existing functionality (AC: 8)
  - [x] Run all existing webhook handler tests
  - [x] Verify `updateCustomerScore()` still called correctly
  - [x] Verify alerts creation for fraud detection unchanged
  - [x] Verify legitimate payments not affected

---

## Dev Notes

### Relevant Source Tree

**Integration Point:**
- `lib/actions/stripe-webhook-handlers.ts` ligne 399 - `handlePaymentIntentSucceeded()`
- Function signature: `async function handlePaymentIntentSucceeded(event: Stripe.Event, connection: StripeConnection)`
- Access organizationId via: `connection.organizationId`
- Current flow: `payment_intent.succeeded` → `updateCustomerScore()` → ... (add refund check here)

**Dependencies:**
- Story 1.1 `lib/actions/auto-refund.ts` - Must be completed first (contains `autoRefundFraudulentPayment()`)
- `lib/db/schemas/fraudDetections.ts` - Table with `refundId`, `actionTaken`, `actualOutcome` fields
- `lib/db/schemas/alerts.ts` - Table for alert creation
- `lib/stripe/client.ts` - Stripe client utilities (already imported)

**Existing Code Context:**
```typescript
// lib/actions/stripe-webhook-handlers.ts ligne 399
export async function handlePaymentIntentSucceeded(
  event: Stripe.Event,
  connection: StripeConnection
) {
  const paymentIntent = event.data.object as Stripe.PaymentIntent;
  const organizationId = connection.organizationId;
  
  // Get Stripe client
  const stripeClient = getConnectedStripeClient(connection.accessToken);
  const customerId = typeof paymentIntent.customer === "string"
    ? paymentIntent.customer
    : paymentIntent.customer.id;
  
  // Update customer reputation score
  await updateCustomerScore(organizationId, customerId, stripeClient);
  
  // ⚠️ ADD REFUND CHECK HERE ⚠️
  // 1. Fetch fraud detection for this payment intent
  // 2. Check if refund needed
  // 3. Call autoRefundFraudulentPayment()
  // 4. Update fraud detection with refund ID
  // 5. Create alert
  
  // Note: Function does not return { received: true } - it returns void
}
```

**Existing Patterns to Follow:**
- Webhook handler pattern: Function returns void (no explicit return needed)
- Error handling: Use try-catch but continue processing even on errors
- Database updates: Use Drizzle ORM `db.update()` with `where()` clause
- Multi-tenant isolation: Always filter by `organizationId` (extracted from `connection.organizationId`)
- Alert creation: Use existing pattern with `db.insert(alerts).values({})`
- Accessing connection data: `connection.organizationId`, `connection.accessToken`, `connection.stripeAccountId`

**Critical Constraints:**
- Webhook handler MUST complete quickly (Stripe timeout: 30 seconds)
- Refund operation should not block webhook response (use fire-and-forget or async pattern)
- If refund fails, webhook processing continues (graceful error handling)
- No breaking changes to existing webhook flow
- Backwards compatible with existing fraud detections (refundId may be null)
- Use `connection` object for all organization/account data access

**Alert Creation Pattern:**
```typescript
await db.insert(alerts).values({
  id: crypto.randomUUID(),
  organizationId,
  type: "fraud_refunded",
  severity: "high",
  title: "Paiement frauduleux remboursé automatiquement",
  message: `Paiement ${paymentIntent.id} (${paymentIntent.amount / 100}€) remboursé automatiquement`,
  data: {
    paymentIntentId: paymentIntent.id,
    refundId: refundResult.refundId,
    fraudDetectionId,
  },
  isRead: false,
  createdAt: new Date(),
});
```

### Testing

**Test Framework:** Vitest

**Test File Location:** `lib/actions/__tests__/stripe-webhook-handlers.test.ts` (extend existing tests)

**Testing Standards:**
- Integration tests must test complete flow from webhook to DB update
- Mock Stripe webhook events with realistic data
- Mock `autoRefundFraudulentPayment()` to verify it's called correctly
- Verify database updates with actual DB queries (use test database)
- Test error scenarios: refund fails, DB update fails, alert creation fails

**Test Coverage Requirements:**
- All new code paths covered by tests
- Regression tests for existing webhook functionality
- Test both success and failure scenarios

**Test Scenarios:**
1. Fraudulent payment succeeded → refund created → DB updated → alert created
2. Legitimate payment succeeded → no refund → no changes
3. Refund fails → error logged → alert created → webhook completes successfully
4. Existing webhook tests still pass (no regression)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial story creation for Epic 1 | Sarah (Product Owner) |
| 2026-01-08 | 1.1 | Fixed handlePaymentIntentSucceeded signature, corrected connection object usage, clarified organizationId extraction, updated integration instructions | Sarah (Product Owner) |
| 2026-01-08 | 1.2 | Implementation complete: Auto-refund integration into webhook handler with comprehensive tests | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (2026-01-08)

### Debug Log References

No critical issues encountered during implementation.

### Completion Notes List

- Integrated auto-refund logic into `handlePaymentIntentSucceeded()` webhook handler
- Added logic to check fraud detection records and trigger refunds for confirmed fraud or high-risk payments
- Implemented conditional fraud detection updates to avoid overwriting refund information
- Created comprehensive integration tests (11 test cases) covering success, failure, and edge cases
- All tests passing, including regression tests for existing auto-refund functionality

### File List

**Modified:**
- `lib/actions/stripe-webhook-handlers.ts` - Added auto-refund integration into payment success handler

**Created:**
- `lib/actions/__tests__/stripe-webhook-handlers.test.ts` - Integration tests for auto-refund functionality

---

## QA Results

_To be filled by QA agent_
