---
description: Orylo V2 - Fraud Detection Platform
globs: 
alwaysApply: true
---

# Orylo V2 - Project Rules

## üéØ Project Overview

Orylo is a **SaaS fraud detection platform** for Stripe merchants. It analyzes payment transactions in real-time using a rules-based engine and AI-powered explanations to detect and prevent fraud, with a focus on **card testing attacks**.

## üõ† Tech Stack

### Core
- **Framework**: Next.js 16.1.1 (App Router)
- **Runtime**: React 19.2.3
- **Language**: TypeScript (strict mode)
- **Package Manager**: Bun (`bun add`, `bun install`, `bun run`)

### Database & ORM
- **Database**: PostgreSQL via Neon Serverless (`@neondatabase/serverless`)
- **ORM**: Drizzle ORM with `drizzle-zod` for validation schemas
- **Migrations**: `bun run db:generate`, `bun run db:migrate`, `bun run db:push`

### Authentication
- **Library**: Better Auth (`better-auth`)
- **Plugins**: Organizations, Two-Factor
- **Pattern**: Server-side `auth` instance + Client-side `authClient`

### State Management & Data Fetching
- **Server State**: TanStack React Query
- **URL State**: nuqs
- **Client State**: Zustand (when needed)
- **Forms**: TanStack React Form

### UI & Styling
- **CSS**: Tailwind CSS v4
- **Components**: Custom Shadcn-based components with CVA (class-variance-authority)
- **Icons**: Lucide React, Phosphor Icons
- **Animations**: Framer Motion
- **Theme**: Dark mode by default (`next-themes`)

### AI & ML
- **Framework**: Mastra AI SDK (`@mastra/core`, `@mastra/ai-sdk`)
- **Provider**: OpenAI (gpt-4o-mini)
- **Usage**: Fraud explanation generation, customer analysis

### Payments & Billing
- **Payments**: Stripe (Connect for merchants, webhooks)
- **Billing**: Autumn.js for usage-based billing

---

## üìÅ Project Structure

```
orylo-v2/
‚îú‚îÄ‚îÄ app/                          # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/                   # Auth pages group (sign-in, sign-up, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ (main)/                   # Main app group (dashboard, onboarding)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/            # Dashboard pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ onboarding/           # User onboarding flow
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-organization/  # Org creation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ select-organization/  # Org selection
‚îÇ   ‚îú‚îÄ‚îÄ (marketing)/              # Marketing pages (about, blog, contact)
‚îÇ   ‚îî‚îÄ‚îÄ api/                      # API routes
‚îÇ       ‚îú‚îÄ‚îÄ auth/                 # Better Auth handler
‚îÇ       ‚îú‚îÄ‚îÄ stripe/               # Stripe webhooks
‚îÇ       ‚îî‚îÄ‚îÄ fraud-analyses/       # Fraud analysis endpoints
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # Base UI components (Button, Card, Dialog, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ auth/                     # Auth-related components
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/                # Dashboard-specific components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialogs/              # Modal dialogs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/               # Sidebar, header
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pages/                # Page-specific component folders
‚îÇ   ‚îú‚îÄ‚îÄ landing/                  # Landing page sections
‚îÇ   ‚îú‚îÄ‚îÄ marketing/                # Marketing page components
‚îÇ   ‚îî‚îÄ‚îÄ onboarding/               # Onboarding forms
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ actions/                  # Server Actions
‚îÇ   ‚îú‚îÄ‚îÄ auth/                     # Better Auth config (server + client)
‚îÇ   ‚îú‚îÄ‚îÄ config/                   # App configuration (menus, breadcrumbs)
‚îÇ   ‚îú‚îÄ‚îÄ context/                  # React Context providers
‚îÇ   ‚îú‚îÄ‚îÄ db/                       # Database config & schemas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/              # Drizzle table schemas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/           # SQL migrations
‚îÇ   ‚îú‚îÄ‚îÄ fraud-detection/          # Fraud detection engine
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine.ts             # Main detection logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts              # TypeScript types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ card-testing.ts       # Card testing detection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ velocity.ts           # Velocity tracking
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ trust-score.ts        # Customer trust scoring
‚îÇ   ‚îú‚îÄ‚îÄ mastra/                   # Mastra AI agents & prompts
‚îÇ   ‚îî‚îÄ‚îÄ stripe/                   # Stripe utilities
‚îú‚îÄ‚îÄ hooks/                        # Custom React hooks
‚îî‚îÄ‚îÄ content/                      # MDX content (blog, docs)
```

---

## üîß Code Conventions

### File Naming
- **Components**: `kebab-case.tsx` (e.g., `stats-grid.tsx`, `create-rule-dialog.tsx`)
- **Schemas**: `camelCase.ts` (e.g., `fraudDetections.ts`, `stripeConnections.ts`)
- **Actions**: `kebab-case.ts` (e.g., `fraud-analyses.ts`, `stripe-connect.ts`)

### Component Patterns
```tsx
// Server Component (default)
const MyComponent = async ({ data }: { data: MyType }) => {
  const result = await fetchData();
  return <div>{result}</div>;
};

// Client Component
"use client";
const MyClientComponent = ({ children }: { children: React.ReactNode }) => {
  const [state, setState] = useState();
  return <div>{children}</div>;
};
```

### Server Actions
```ts
"use server";

import { db } from "@/lib/db";
import { auth } from "@/lib/auth/auth.server";
import { headers } from "next/headers";

export async function myAction(input: MyInput) {
  // Always validate session for protected actions
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session) throw new Error("Unauthorized");
  
  // Use drizzle for DB operations
  const result = await db.query.myTable.findMany({
    where: eq(myTable.organizationId, session.session.activeOrganizationId),
  });
  
  return result;
}
```

### Database Schema Pattern
```ts
// lib/db/schemas/myTable.ts
import { pgTable, text, timestamp, jsonb, index } from "drizzle-orm/pg-core";
import { InferSelectModel, InferInsertModel, relations } from "drizzle-orm";
import { createInsertSchema, createSelectSchema } from "drizzle-zod";

export const myTable = pgTable("my_table", {
  id: text("id").primaryKey().$defaultFn(() => crypto.randomUUID()),
  organizationId: text("organization_id").notNull()
    .references(() => organization.id, { onDelete: "cascade" }),
  data: jsonb("data").$type<MyDataType>().default({}),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
}, (table) => [
  index("my_table_org_idx").on(table.organizationId),
]);

export const myTableRelations = relations(myTable, ({ one }) => ({
  organization: one(organization, {
    fields: [myTable.organizationId],
    references: [organization.id],
  }),
}));

// Export types
export type MyRecord = InferSelectModel<typeof myTable>;
export type NewMyRecord = InferInsertModel<typeof myTable>;
export const myTableInsertSchema = createInsertSchema(myTable);
export const myTableSelectSchema = createSelectSchema(myTable);
```

### UI Component Pattern (CVA)
```tsx
import { cva, type VariantProps } from "class-variance-authority";
import { cn } from "@/lib/utils";

const myComponentVariants = cva("base-classes", {
  variants: {
    variant: {
      default: "variant-default-classes",
      secondary: "variant-secondary-classes",
    },
    size: {
      default: "size-default-classes",
      sm: "size-sm-classes",
    },
  },
  defaultVariants: {
    variant: "default",
    size: "default",
  },
});

function MyComponent({
  className,
  variant,
  size,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof myComponentVariants>) {
  return (
    <div
      className={cn(myComponentVariants({ variant, size, className }))}
      {...props}
    />
  );
}
```

---

## üîê Authentication Pattern

### Server-side (Protected Routes/Actions)
```ts
import { auth } from "@/lib/auth/auth.server";
import { headers } from "next/headers";

// In Server Component or Server Action
const session = await auth.api.getSession({ headers: await headers() });
if (!session) redirect("/sign-in");

const organizationId = session.session.activeOrganizationId;
```

### Client-side
```ts
import { useSession, useActiveOrganization } from "@/lib/auth/auth.client";

// In Client Component
const { data: session, isPending } = useSession();
const { data: organization } = useActiveOrganization();
```

---

## üö® Fraud Detection System

### Core Engine (`lib/fraud-detection/engine.ts`)
The fraud detection uses a **rules-based scoring system**:
- Analyzes `TransactionContext` with card, customer, velocity data
- Applies positive/negative rules that adjust `riskScore` (0-100)
- Returns `FraudDecision`: `ALLOW`, `REVIEW`, or `BLOCK`

### Key Types (`lib/fraud-detection/types.ts`)
- `TransactionContext`: Full transaction data for analysis
- `FraudDetectionResult`: Decision + score + factors
- `FraudFactor`: Individual risk factor with weight & severity
- `CustomerTier`: `blocked` | `suspicious` | `new` | `trusted` | `vip`

### Card Testing Detection
Special focus on detecting **card testing attacks**:
- Multiple unique cards from same IP/session
- Rapid succession of small-amount transactions
- High failure rates with sequential card numbers

---

## üé® UI Guidelines

### Theme
- **Primary palette**: Indigo/Purple gradients on dark zinc background
- **Accent colors**: Emerald (success), Rose (error), Amber (warning)
- **Cards**: `bg-zinc-900/50 border border-white/5 backdrop-blur-xl`

### Dashboard Pattern
```tsx
<div className="bg-black space-y-4 relative overflow-hidden min-h-screen">
  {/* Background Effects */}
  <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_top,var(--tw-gradient-stops))] from-indigo-900/20 via-zinc-900/0 to-zinc-900/0 pointer-events-none" />
  
  {/* Content */}
  <div className="relative z-10">
    {/* ... */}
  </div>
</div>
```

### Imports
```tsx
// UI Components from @/components/ui/
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";

// Icons from lucide-react
import { ShieldAlert, Activity, Settings } from "lucide-react";
```

---

## ‚ö†Ô∏è Important Rules

1. **Always reuse existing types** from `lib/db/schemas` or `lib/fraud-detection/types.ts`
2. **Use `productIds` array** instead of `productId` with options when possible
3. **Use `Container` from react-email** for email layouts, not plain `div`
4. **Stick to existing theme** - don't create overly audacious UI designs
5. **Use nested routes** - project uses nested React Router routes, not flat routes
6. **Server-first**: Default to Server Components, use `"use client"` only when needed
7. **French language**: Application content and AI explanations are in French
8. **Organization-scoped**: All data queries must filter by `organizationId`

---

## üöÄ Common Commands

```bash
# Development
bun run dev

# Database
bun run db:generate    # Generate migrations
bun run db:migrate     # Run migrations
bun run db:push        # Push schema changes
bun run db:studio      # Open Drizzle Studio

# Build & Deploy
bun run build
bun run start
bun run lint
```

---

## üì¶ Key Dependencies

| Package | Purpose |
|---------|---------|
| `better-auth` | Authentication + Organizations |
| `drizzle-orm` | Database ORM |
| `@neondatabase/serverless` | PostgreSQL connection |
| `@tanstack/react-query` | Server state management |
| `@tanstack/react-form` | Form handling |
| `@mastra/core` | AI agents framework |
| `stripe` | Payment processing |
| `autumn-js` | Usage-based billing |
| `nuqs` | URL state management |
| `sonner` | Toast notifications |
| `framer-motion` | Animations |
